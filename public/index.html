<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="theme-color" content="#4a7c59">
<title>BabyMeal</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@800;900&family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
<style>
:root {
  --g:#4a7c59; --gl:#6aab7a; --gp:#e8f5ec; --gm:#c5e4cc;
  --or:#f4845f; --op:#fde8e0; --ye:#f9c74f;
  --cr:#faf8f3; --tx:#2d2d2d; --sb:#7a7a7a; --wh:#ffffff;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{font-family:'Noto Sans JP',sans-serif;background:var(--cr);color:var(--tx);min-height:100vh}
#app{max-width:430px;margin:0 auto;min-height:100vh;position:relative}

/* â”€â”€ Splash â”€â”€ */
#splash{position:fixed;inset:0;background:var(--g);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000;transition:opacity .5s}
#splash.hide{opacity:0;pointer-events:none}
#splash .logo{font-size:72px;animation:bounceIn .6s ease}
#splash h1{font-family:'Nunito',sans-serif;color:#fff;font-size:34px;font-weight:900;margin-top:8px}
#splash p{color:rgba(255,255,255,.7);font-size:13px;margin-top:6px}

/* â”€â”€ Onboarding â”€â”€ */
#onboarding{position:fixed;inset:0;background:var(--cr);z-index:900;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:28px 22px;overflow-y:auto}
#onboarding.hide{display:none}
.ob-step{display:none;width:100%;flex-direction:column;align-items:center}
.ob-step.active{display:flex}
.ob-icon{font-size:56px;margin-bottom:14px}
.ob-title{font-size:24px;font-weight:900;color:var(--g);margin-bottom:8px;text-align:center}
.ob-sub{font-size:14px;color:var(--sb);text-align:center;margin-bottom:22px;line-height:1.6}

/* â”€â”€ Header â”€â”€ */
#header{position:sticky;top:0;z-index:100;background:var(--wh);padding:12px 18px 10px;border-bottom:1px solid var(--gm);display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 12px rgba(74,124,89,.08)}
.logo{font-family:'Nunito',sans-serif;font-weight:900;font-size:20px;color:var(--g)}
.stage-badge{background:var(--gp);color:var(--g);font-size:11px;font-weight:700;padding:3px 10px;border-radius:20px}

/* â”€â”€ Nav â”€â”€ */
#nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;background:var(--wh);border-top:1px solid var(--gm);display:flex;z-index:100;padding-bottom:env(safe-area-inset-bottom)}
.nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;padding:9px 4px 7px;cursor:pointer;border:none;background:none;color:var(--sb);font-size:10px;font-weight:700;gap:2px;font-family:inherit;transition:color .2s}
.nav-btn .ni{font-size:20px;transition:transform .2s}
.nav-btn.active{color:var(--g)}
.nav-btn.active .ni{transform:scale(1.15)}

/* â”€â”€ Pages â”€â”€ */
.page{display:none;padding:14px 14px 90px;animation:fadeUp .25s ease}
.page.active{display:block}

/* â”€â”€ Cards â”€â”€ */
.card{background:var(--wh);border-radius:18px;padding:18px;box-shadow:0 4px 20px rgba(74,124,89,.1);margin-bottom:14px}
.card-title{font-size:11px;font-weight:700;color:var(--sb);text-transform:uppercase;letter-spacing:.6px;margin-bottom:12px}
.sec-title{font-size:17px;font-weight:900;margin-bottom:13px}

/* â”€â”€ Hero â”€â”€ */
.hero{background:linear-gradient(135deg,var(--g),var(--gl));border-radius:18px;padding:22px 18px;margin-bottom:14px;color:#fff;position:relative;overflow:hidden}
.hero::before{content:'ğŸ¼';position:absolute;right:14px;top:50%;transform:translateY(-50%);font-size:58px;opacity:.18}
.hero .hdate{font-size:12px;opacity:.75;margin-bottom:4px}
.hero h2{font-size:19px;font-weight:900;margin-bottom:3px}
.hero p{font-size:13px;opacity:.82}

/* â”€â”€ Meal slots â”€â”€ */
.slot{border:2px dashed var(--gm);border-radius:12px;padding:13px 14px;margin-bottom:9px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:11px}
.slot:hover{border-color:var(--g);background:var(--gp)}
.slot.done{border:2px solid var(--gm);background:var(--gp);cursor:default}
.slot-icon{font-size:26px}
.slot-lbl{font-size:11px;color:var(--sb);font-weight:700}
.slot-name{font-size:14px;font-weight:700}
.slot-meta{font-size:12px;color:var(--sb);margin-top:2px}

/* â”€â”€ Buttons â”€â”€ */
.btn{width:100%;border:none;border-radius:12px;padding:13px;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:7px}
.btn-g{background:var(--g);color:#fff}
.btn-g:hover{background:var(--gl);transform:translateY(-1px)}
.btn-outline{background:var(--gp);color:var(--g);border:2px solid var(--gm)}
.btn-outline:hover{background:var(--gm)}
.btn-danger{background:#fee2e2;color:#991b1b}
.btn-sm{width:auto;padding:8px 16px;font-size:13px}
.flex2{display:flex;gap:9px}
.flex2 .btn{flex:1}

/* â”€â”€ AI card â”€â”€ */
.ai-card{background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:18px;padding:18px;margin-bottom:14px;color:#fff}
.ai-badge{display:inline-flex;align-items:center;gap:5px;background:rgba(255,255,255,.15);border-radius:20px;padding:3px 11px;font-size:11px;font-weight:700;margin-bottom:12px}
.ai-pulse{width:6px;height:6px;background:#4ade80;border-radius:50%;animation:pulse 2s infinite;display:inline-block}
.ai-btn{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.3);border-radius:12px;padding:13px;font-size:14px;font-weight:700;color:#fff;cursor:pointer;width:100%;font-family:inherit;display:flex;align-items:center;justify-content:center;gap:7px}
.ai-btn:disabled{opacity:.5;cursor:default}
.dot3 span{width:7px;height:7px;background:var(--gl);border-radius:50%;display:inline-block;animation:bounce 1.2s infinite;margin:0 2px}
.dot3 span:nth-child(2){animation-delay:.2s}
.dot3 span:nth-child(3){animation-delay:.4s}
.proposal-box{background:rgba(255,255,255,.08);border-radius:12px;padding:12px;margin:12px 0}
.menu-row{display:flex;align-items:flex-start;gap:9px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.07)}
.menu-row:last-child{border-bottom:none}
.menu-icon{font-size:20px;flex-shrink:0;margin-top:1px}
.menu-info{flex:1}
.menu-name{font-size:14px;font-weight:700}
.menu-ingredients{font-size:11px;opacity:.7;margin-top:3px;line-height:1.6}
.tag{font-size:10px;padding:2px 8px;border-radius:10px;font-weight:700;flex-shrink:0}
.tag-new{background:rgba(249,199,79,.2);color:var(--ye)}
.tag-stock{background:rgba(74,222,128,.15);color:#4ade80}

/* â”€â”€ Nutrition suggestion â”€â”€ */
.nutr-suggest{background:rgba(255,255,255,.06);border-radius:12px;padding:12px;margin-top:10px}
.nutr-suggest-title{font-size:12px;font-weight:700;opacity:.8;margin-bottom:8px}
.suggest-item{display:flex;align-items:flex-start;gap:7px;padding:5px 0;border-bottom:1px solid rgba(255,255,255,.05)}
.suggest-item:last-child{border-bottom:none}
.suggest-food{font-size:13px;font-weight:700;flex:1}
.suggest-amount{font-size:11px;opacity:.65;margin-top:2px}

/* â”€â”€ Proposal action btns â”€â”€ */
.prop-btns{display:flex;gap:8px;margin-top:12px}
.prop-btn{flex:1;border-radius:10px;padding:10px;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;border:1px solid rgba(255,255,255,.3)}
.prop-adopt{background:rgba(74,222,128,.2);color:#4ade80}
.prop-adopt.done{cursor:default;opacity:.7}
.prop-retry{background:transparent;color:rgba(255,255,255,.7)}

/* â”€â”€ Error box â”€â”€ */
.err-box{background:rgba(244,132,95,.18);border:1px solid rgba(244,132,95,.5);border-radius:10px;padding:12px;margin-top:12px}
.err-title{font-size:12px;font-weight:700;color:var(--or);margin-bottom:6px}
.err-pre{font-size:11px;color:rgba(255,255,255,.7);white-space:pre-wrap;word-break:break-all;font-family:monospace;line-height:1.5}

/* â”€â”€ Record items â”€â”€ */
.day-hd{font-size:12px;font-weight:700;color:var(--sb);margin-bottom:9px;display:flex;align-items:center;gap:7px}
.day-hd::after{content:'';flex:1;height:1px;background:var(--gm)}
.rec-item{background:var(--wh);border-radius:12px;padding:13px 14px;margin-bottom:8px;display:flex;align-items:center;gap:11px;box-shadow:0 2px 8px rgba(74,124,89,.07)}
.rec-thumb{width:50px;height:50px;border-radius:9px;background:var(--gp);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;overflow:hidden}
.rec-thumb img{width:100%;height:100%;object-fit:cover}
.rec-name{font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.rec-meta{font-size:12px;color:var(--sb);margin-top:2px}
.rbadge{font-size:11px;padding:3px 9px;border-radius:20px;font-weight:700;white-space:nowrap}
.r-all{background:#dcfce7;color:#15803d}
.r-half{background:#fef9c3;color:#854d0e}
.r-no{background:#fee2e2;color:#991b1b}

/* â”€â”€ Stock grid â”€â”€ */
.stock-grid{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:14px}
.stock-item{background:var(--wh);border-radius:12px;padding:13px;box-shadow:0 2px 8px rgba(74,124,89,.07);position:relative}
.stock-item.warn{border:2px solid var(--or);background:var(--op)}
.s-del{position:absolute;top:7px;right:7px;background:none;border:none;font-size:14px;cursor:pointer;opacity:.35;line-height:1}
.s-del:hover{opacity:1}
.s-emoji{font-size:26px;margin-bottom:7px}
.s-name{font-size:13px;font-weight:700}
.s-amt{font-size:12px;color:var(--sb)}
.s-exp{font-size:11px;font-weight:600;margin-top:5px}
.s-ok{color:var(--g)}
.s-warn{color:var(--or)}

/* â”€â”€ Modal â”€â”€ */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;display:flex;align-items:flex-end;backdrop-filter:blur(4px)}
.modal-bg.hide{display:none}
.modal{background:var(--wh);border-radius:22px 22px 0 0;padding:22px 18px 36px;width:100%;max-width:430px;margin:0 auto;max-height:90vh;overflow-y:auto;animation:slideUp .28s ease}
.modal-handle{width:38px;height:4px;background:var(--gm);border-radius:2px;margin:0 auto 18px}
.modal h3{font-size:17px;font-weight:900;margin-bottom:18px}

/* â”€â”€ Forms â”€â”€ */
.fg{margin-bottom:14px}
.fl{font-size:13px;font-weight:700;color:var(--sb);margin-bottom:5px;display:block}
.fi{width:100%;border:2px solid var(--gm);border-radius:12px;padding:11px 13px;font-size:14px;font-family:inherit;outline:none;background:var(--wh);transition:border-color .2s}
.fi:focus{border-color:var(--g)}
.photo-area{border:2px dashed var(--gm);border-radius:12px;padding:20px;text-align:center;cursor:pointer;background:var(--gp);margin-bottom:10px;transition:all .2s}
.photo-area:hover{border-color:var(--g)}
.reaction-row{display:flex;gap:7px}
.ropt{flex:1;padding:9px;border:2px solid var(--gm);border-radius:12px;text-align:center;cursor:pointer;font-size:12px;font-weight:700;transition:all .2s;background:var(--wh)}
.ropt.sel{border-color:var(--g);background:var(--gp);color:var(--g)}
.ropt-e{font-size:19px;display:block;margin-bottom:3px}

/* â”€â”€ Nutr card â”€â”€ */
.nutr-card{background:var(--gp);border-radius:10px;padding:14px;margin-top:10px}
.nutr-row{margin-bottom:9px}
.nutr-hd{display:flex;justify-content:space-between;margin-bottom:3px;font-size:12px;font-weight:600}
.nutr-track{height:8px;background:#d1fae5;border-radius:4px;overflow:hidden}
.nutr-fill{height:100%;border-radius:4px;transition:width 1s ease}

/* â”€â”€ Settings â”€â”€ */
.srow{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--gp)}
.srow:last-child{border-bottom:none}
.srow-lbl{font-size:15px;font-weight:700}
.srow-val{font-size:14px;color:var(--g);font-weight:700}
.srow-edit{font-size:12px;color:var(--g);cursor:pointer;text-decoration:underline;margin-left:8px}
.toggle{width:46px;height:25px;background:var(--gm);border-radius:13px;position:relative;cursor:pointer;transition:background .2s;flex-shrink:0;border:none}
.toggle.on{background:var(--g)}
.toggle::after{content:'';position:absolute;top:3px;left:3px;width:19px;height:19px;background:#fff;border-radius:50%;transition:transform .2s;box-shadow:0 2px 4px rgba(0,0,0,.18)}
.toggle.on::after{transform:translateX(21px)}
.atag-wrap{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:11px;min-height:28px}
.atag{background:var(--op);color:var(--or);font-size:12px;font-weight:700;padding:4px 11px;border-radius:20px;display:flex;align-items:center;gap:5px}
.atag button{background:none;border:none;cursor:pointer;font-size:13px;line-height:1;color:var(--or);padding:0}

/* â”€â”€ Empty state â”€â”€ */
.empty{text-align:center;padding:40px 18px;color:var(--sb)}
.empty-icon{font-size:46px;margin-bottom:10px}

/* â”€â”€ Animations â”€â”€ */
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
@keyframes bounceIn{from{transform:scale(.3);opacity:0}to{transform:scale(1);opacity:1}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
@keyframes bounce{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-7px)}}
</style>
</head>
<body>
<div id="app">

<!-- â”€â”€ Splash â”€â”€ -->
<div id="splash">
  <div class="logo">ğŸ¼</div>
  <h1>BabyMeal</h1>
  <p>èµ¤ã¡ã‚ƒã‚“ã®é£Ÿäº‹ã‚’ã€ã‚‚ã£ã¨ã‹ã‚“ãŸã‚“ã«</p>
</div>

<!-- â”€â”€ Onboarding â”€â”€ -->
<div id="onboarding" class="hide">
  <div class="ob-step active" id="ob1">
    <div class="ob-icon">ğŸ‘¶</div>
    <div class="ob-title">ã¯ã˜ã‚ã¾ã—ã¦ï¼</div>
    <div class="ob-sub">èµ¤ã¡ã‚ƒã‚“ã®æƒ…å ±ã‚’æ•™ãˆã¦ãã ã•ã„<br>ã‚ã¨ã‹ã‚‰è¨­å®šã§å¤‰æ›´ã§ãã¾ã™</div>
    <div style="width:100%">
      <div class="fg">
        <label class="fl">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </label>
        <input class="fi" id="ob-name" placeholder="ä¾‹ï¼šã¯ã‚‹ãã‚“">
      </div>
      <div class="fg">
        <label class="fl">ç”Ÿå¹´æœˆæ—¥ï¼ˆå¹´æœˆï¼‰</label>
        <input type="month" class="fi" id="ob-birth">
      </div>
    </div>
    <button class="btn btn-g" onclick="obNext()">æ¬¡ã¸ â†’</button>
  </div>
  <div class="ob-step" id="ob2">
    <div class="ob-icon">âš ï¸</div>
    <div class="ob-title">ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼é£Ÿæ</div>
    <div class="ob-sub">é™¤å»ãƒ»æœªç¢ºèªã®é£ŸæãŒã‚ã‚Œã°å…¥åŠ›ã—ã¦ãã ã•ã„<br>ï¼ˆå¾Œã‹ã‚‰è¨­å®šã§å¤‰æ›´ã§ãã¾ã™ï¼‰</div>
    <div style="width:100%;margin-bottom:16px">
      <div class="atag-wrap" id="ob-alls"></div>
      <div style="display:flex;gap:8px">
        <input class="fi" id="ob-all-input" placeholder="ä¾‹ï¼šåµã€ãˆã³" style="flex:1" onkeydown="if(event.key==='Enter')obAddAll()">
        <button class="btn btn-outline btn-sm" onclick="obAddAll()">è¿½åŠ </button>
      </div>
    </div>
    <button class="btn btn-g" onclick="obFinish()">ğŸ‰ ã¯ã˜ã‚ã‚‹</button>
    <button class="btn btn-outline" style="margin-top:8px" onclick="obFinish()">ã‚¹ã‚­ãƒƒãƒ—</button>
  </div>
</div>

<!-- â”€â”€ Header â”€â”€ -->
<div id="header" style="display:none">
  <div class="logo">ğŸ¼ BabyMeal</div>
  <div style="text-align:right">
    <div style="font-size:13px;color:var(--sb)" id="hd-name">ğŸ‘¶ â€”</div>
    <div class="stage-badge" id="hd-stage">â€”</div>
  </div>
</div>

<!-- â”€â”€ Pages â”€â”€ -->
<div id="pg-home" class="page active">
  <div class="hero">
    <div class="hdate" id="today-str"></div>
    <h2>ä»Šæ—¥ã®é›¢ä¹³é£Ÿ ğŸ“‹</h2>
    <p>3é£Ÿã®è¨˜éŒ²ã¨çŒ®ç«‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã‚ˆã†</p>
  </div>
  <div class="card">
    <div class="card-title">ä»Šæ—¥ã®é£Ÿäº‹è¨˜éŒ²</div>
    <div id="slots"></div>
  </div>
  <!-- AI proposal -->
  <div class="ai-card">
    <div class="ai-badge"><span class="ai-pulse"></span>AIææ¡ˆ</div>
    <div style="font-size:15px;font-weight:900;margin-bottom:10px">æ¬¡å›ã®çŒ®ç«‹ã‚’ææ¡ˆã™ã‚‹</div>
    <p style="font-size:13px;opacity:.7;margin-bottom:14px;line-height:1.6">ç›´è¿‘3é£Ÿãƒ»å†·å‡ã‚¹ãƒˆãƒƒã‚¯ãƒ»æ „é¤Šãƒãƒ©ãƒ³ã‚¹ã‚’ã‚‚ã¨ã«AIãŒçŒ®ç«‹ã¨é£Ÿæã®1å›é‡ã‚’ææ¡ˆã—ã¾ã™</p>
    <button class="ai-btn" id="propose-btn" onclick="runPropose()">âœ¨ çŒ®ç«‹ã‚’ææ¡ˆã—ã¦ã‚‚ã‚‰ã†</button>
    <div id="propose-result"></div>
  </div>
</div>

<div id="pg-record" class="page">
  <div class="sec-title">ğŸ“– é£Ÿäº‹è¨˜éŒ²</div>
  <div id="rec-list"></div>
  <button class="btn btn-g" onclick="openRecModal()">ï¼‹ é£Ÿäº‹ã‚’è¨˜éŒ²ã™ã‚‹</button>
</div>

<div id="pg-stock" class="page">
  <div class="sec-title">ğŸ§Š å†·å‡ã‚¹ãƒˆãƒƒã‚¯</div>
  <div class="card" style="padding:12px 16px;margin-bottom:10px">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div style="font-size:13px;font-weight:700;color:var(--sb)">ç¾åœ¨ã®åœ¨åº«</div>
      <div style="font-size:22px;font-weight:900;color:var(--g)" id="stock-count">0å“</div>
    </div>
    <div id="stock-warn-msg" style="font-size:12px;color:var(--or);margin-top:4px;display:none"></div>
  </div>
  <div class="stock-grid" id="stock-grid"></div>
  <div id="stock-empty" class="empty" style="display:none">
    <div class="empty-icon">ğŸ§Š</div>
    <p>å†·å‡ã‚¹ãƒˆãƒƒã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</p>
  </div>
  <button class="btn btn-g" onclick="openStockModal()">ï¼‹ ã‚¹ãƒˆãƒƒã‚¯ã‚’è¿½åŠ ã™ã‚‹</button>
</div>

<div id="pg-settings" class="page">
  <div class="sec-title">âš™ï¸ è¨­å®š</div>
  <div class="card">
    <div class="card-title">èµ¤ã¡ã‚ƒã‚“æƒ…å ±</div>
    <div class="srow">
      <div class="srow-lbl">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </div>
      <div><span class="srow-val" id="s-name">â€”</span><span class="srow-edit" onclick="editName()">å¤‰æ›´</span></div>
    </div>
    <div class="srow">
      <div class="srow-lbl">ç”Ÿå¹´æœˆæ—¥</div>
      <div><span class="srow-val" id="s-birth">â€”</span><span class="srow-edit" onclick="editBirth()">å¤‰æ›´</span></div>
    </div>
    <div class="srow">
      <div class="srow-lbl">ã‚¹ãƒ†ãƒ¼ã‚¸</div>
      <span class="srow-val" id="s-stage">â€”</span>
    </div>
    <div class="srow" style="border:none">
      <div class="srow-lbl">æœˆé½¢</div>
      <span class="srow-val" id="s-months">â€”</span>
    </div>
  </div>
  <div class="card">
    <div class="card-title">ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ãƒ»é™¤å»é£Ÿæ</div>
    <div class="atag-wrap" id="s-alls"></div>
    <div style="display:flex;gap:8px">
      <input class="fi" id="s-all-input" placeholder="é£Ÿæåã‚’å…¥åŠ›" style="flex:1;font-size:14px;padding:10px 12px" onkeydown="if(event.key==='Enter')sAddAll()">
      <button class="btn btn-outline btn-sm" onclick="sAddAll()">è¿½åŠ </button>
    </div>
  </div>
  <div class="card">
    <div class="card-title">è¡¨ç¤ºè¨­å®š</div>
    <div class="srow">
      <div>
        <div class="srow-lbl">åˆé£Ÿæã‚¢ãƒ©ãƒ¼ãƒˆ</div>
        <div style="font-size:12px;color:var(--sb);margin-top:2px">åˆã‚ã¦ã®é£Ÿæã‚’ä½¿ã†éš›ã«è¡¨ç¤º</div>
      </div>
      <button class="toggle" id="tog-first" onclick="togFirst()"></button>
    </div>
    <div class="srow" style="border:none">
      <div>
        <div class="srow-lbl">å†·å‡æœŸé™ã‚¢ãƒ©ãƒ¼ãƒˆ</div>
        <div style="font-size:12px;color:var(--sb);margin-top:2px">æœŸé™3æ—¥å‰ã«è­¦å‘Šè¡¨ç¤º</div>
      </div>
      <button class="toggle" id="tog-exp" onclick="togExp()"></button>
    </div>
  </div>
  <div class="card">
    <div class="card-title" style="color:#991b1b">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</div>
    <button class="btn btn-danger" onclick="resetData()">ğŸ—‘ ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
</div>

<!-- â”€â”€ Bottom Nav â”€â”€ -->
<nav id="nav" style="display:none">
  <button class="nav-btn active" onclick="goPage('home')" id="nb-home"><span class="ni">ğŸ </span>ãƒ›ãƒ¼ãƒ </button>
  <button class="nav-btn" onclick="goPage('record')" id="nb-record"><span class="ni">ğŸ“–</span>è¨˜éŒ²</button>
  <button class="nav-btn" onclick="goPage('stock')" id="nb-stock"><span class="ni">ğŸ§Š</span>å†·å‡</button>
  <button class="nav-btn" onclick="goPage('settings')" id="nb-settings"><span class="ni">âš™ï¸</span>è¨­å®š</button>
</nav>

<!-- â”€â”€ Record Modal â”€â”€ -->
<div class="modal-bg hide" id="rec-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <h3>é£Ÿäº‹ã‚’è¨˜éŒ²ã™ã‚‹</h3>
    <div class="fg">
      <label class="fl">ğŸ“¸ å†™çœŸï¼ˆAIæ „é¤Šè§£æï¼‰</label>
      <div class="photo-area" id="photo-area" onclick="document.getElementById('photo-input').click()">
        <div style="font-size:32px;margin-bottom:6px">ğŸ“·</div>
        <p style="font-size:13px;color:var(--sb)">ã‚¿ãƒƒãƒ—ã—ã¦å†™çœŸã‚’é¸ã¶<br><span style="font-size:11px;color:var(--g)">AIãŒé£Ÿæãƒ»æ „é¤Šã‚’è‡ªå‹•è§£æã—ã¾ã™</span></p>
      </div>
      <input type="file" id="photo-input" accept="image/*" style="display:none" onchange="handlePhoto(event)">
      <div id="vision-result"></div>
    </div>
    <div class="fg">
      <label class="fl">ğŸ• é£Ÿäº‹ã®æ™‚é–“å¸¯</label>
      <select class="fi" id="rec-time">
        <option value="æœã”ã¯ã‚“">ğŸŒ… æœã”ã¯ã‚“</option>
        <option value="ã²ã‚‹ã”ã¯ã‚“">â˜€ï¸ ã²ã‚‹ã”ã¯ã‚“</option>
        <option value="æ™©ã”ã¯ã‚“">ğŸŒ™ æ™©ã”ã¯ã‚“</option>
        <option value="ãŠã‚„ã¤">ğŸª ãŠã‚„ã¤</option>
      </select>
    </div>
    <div class="fg">
      <label class="fl">ğŸ½ æ–™ç†å</label>
      <input class="fi" id="rec-name" placeholder="ä¾‹ï¼šã‹ã¼ã¡ã‚ƒãƒšãƒ¼ã‚¹ãƒˆãƒ»è±†è…">
    </div>
    <div class="fg">
      <label class="fl">ğŸ˜Š é£Ÿã¹ãŸé‡ãƒ»åå¿œ</label>
      <div class="reaction-row">
        <div class="ropt sel" onclick="selReact('all')" id="r-all"><span class="ropt-e">ğŸ˜Š</span>å®Œé£Ÿ</div>
        <div class="ropt" onclick="selReact('half')" id="r-half"><span class="ropt-e">ğŸ˜</span>å°‘ã—æ®‹ã—ãŸ</div>
        <div class="ropt" onclick="selReact('no')" id="r-no"><span class="ropt-e">ğŸ˜£</span>é£Ÿã¹ãªã‹ã£ãŸ</div>
      </div>
    </div>
    <div class="flex2">
      <button class="btn btn-outline" onclick="closeRecModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-g" onclick="saveRecord()">ğŸ’¾ ä¿å­˜ã™ã‚‹</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Stock Modal â”€â”€ -->
<div class="modal-bg hide" id="stock-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <h3>ğŸ§Š ã‚¹ãƒˆãƒƒã‚¯ã‚’è¿½åŠ </h3>
    <div class="fg">
      <label class="fl">çµµæ–‡å­—ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆä»»æ„ï¼‰</label>
      <input class="fi" id="s-emoji" placeholder="ä¾‹ï¼šğŸƒ" maxlength="2">
    </div>
    <div class="fg">
      <label class="fl">æ–™ç†å <span style="color:var(--or)">*</span></label>
      <input class="fi" id="s-sname" placeholder="ä¾‹ï¼šã‹ã¼ã¡ã‚ƒãƒšãƒ¼ã‚¹ãƒˆ">
    </div>
    <div class="fg">
      <label class="fl">é‡</label>
      <input class="fi" id="s-amt" placeholder="ä¾‹ï¼šè£½æ°·çš¿5ãƒã‚¹">
    </div>
    <div class="fg">
      <label class="fl">èª¿ç†æ—¥ <span style="color:var(--or)">*</span></label>
      <input type="date" class="fi" id="s-date">
    </div>
    <div class="flex2">
      <button class="btn btn-outline" onclick="closeStockModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-g" onclick="saveStock()">è¿½åŠ ã™ã‚‹</button>
    </div>
  </div>
</div>

</div><!-- #app -->

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DB = {
  get(k)    { try { return JSON.parse(localStorage.getItem('bm_'+k)); } catch { return null; } },
  set(k,v)  { localStorage.setItem('bm_'+k, JSON.stringify(v)); },
};

let baby     = DB.get('baby')     || null;
let allergens= DB.get('alls')     || [];
let records  = DB.get('recs')     || [];
let stocks   = DB.get('stocks')   || [];
let toggles  = DB.get('toggles') || { firstFood:true, expiry:true };

function save() {
  DB.set('baby',    baby);
  DB.set('alls',    allergens);
  DB.set('recs',    records);
  DB.set('stocks',  stocks);
  DB.set('toggles', toggles);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STAGE CALC
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcStage(birth) {
  if (!birth) return { stage:'â€”', months:0 };
  const now = new Date();
  const b   = new Date(birth + '-01');
  const m   = (now.getFullYear()-b.getFullYear())*12 + now.getMonth()-b.getMonth();
  const s   = m<5?'ã¾ã é›¢ä¹³é£Ÿå‰':m<=6?'ã”ã£ãã‚“æœŸ':m<=8?'ã‚‚ãã‚‚ãæœŸ':m<=11?'ã‹ã¿ã‹ã¿æœŸ':m<=18?'ã±ãã±ãæœŸ':'å¹¼å…é£ŸæœŸ';
  return { stage:s, months:m };
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// API HELPERS (â†’ Vercel functions)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function apiChat(messages) {
  const res  = await fetch('/api/chat', {
    method: 'POST',
    headers: { 'Content-Type':'application/json' },
    body: JSON.stringify({ messages }),
  });
  const data = await res.json();
  if (data.error) throw new Error(data.error);
  return data.text;
}

async function apiVision(base64, mediaType) {
  const res  = await fetch('/api/vision', {
    method: 'POST',
    headers: { 'Content-Type':'application/json' },
    body: JSON.stringify({ base64, mediaType }),
  });
  const data = await res.json();
  if (data.error) throw new Error(data.error);
  return data.text;
}

function parseJSON(raw) {
  return JSON.parse(raw.replace(/```json\s*/g,'').replace(/```\s*/g,'').trim());
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.onload = () => {
  setTimeout(() => {
    document.getElementById('splash').classList.add('hide');
    if (!baby) {
      document.getElementById('onboarding').classList.remove('hide');
    } else {
      showApp();
    }
  }, 1400);
};

function showApp() {
  document.getElementById('onboarding').classList.add('hide');
  document.getElementById('header').style.display = 'flex';
  document.getElementById('nav').style.display = 'flex';
  renderAll();
}

function renderAll() {
  renderHeader();
  renderSlots();
  renderRecords();
  renderStocks();
  renderSettings();

  // Today string
  const now = new Date();
  document.getElementById('today-str').textContent =
    `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ï¼ˆ${'æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ'[now.getDay()]}ï¼‰`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// HEADER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderHeader() {
  const { stage, months } = calcStage(baby?.birth);
  document.getElementById('hd-name').textContent  = `ğŸ‘¶ ${baby?.name||'â€”'}`;
  document.getElementById('hd-stage').textContent = `${stage}ï¼ˆ${months}ãƒ¶æœˆï¼‰`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ONBOARDING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function obNext() {
  const name  = document.getElementById('ob-name').value.trim();
  const birth = document.getElementById('ob-birth').value;
  if (!name)  { alert('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if (!birth) { alert('ç”Ÿå¹´æœˆæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  document.getElementById('ob1').classList.remove('active');
  document.getElementById('ob2').classList.add('active');
}

let obAlls = [];
function obAddAll() {
  const v = document.getElementById('ob-all-input').value.trim();
  if (!v) return;
  obAlls.push(v);
  document.getElementById('ob-all-input').value = '';
  renderObAlls();
}
function renderObAlls() {
  document.getElementById('ob-alls').innerHTML =
    obAlls.map((a,i)=>`<div class="atag">${a}<button onclick="obAlls.splice(${i},1);renderObAlls()">Ã—</button></div>`).join('') ||
    '<span style="font-size:13px;color:var(--sb)">ã¾ã ç™»éŒ²ãªã—</span>';
}

function obFinish() {
  baby = {
    name:  document.getElementById('ob-name').value.trim(),
    birth: document.getElementById('ob-birth').value,
  };
  allergens = [...obAlls];
  save();
  showApp();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PAGE NAV
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function goPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('pg-'+id).classList.add('active');
  document.getElementById('nb-'+id).classList.add('active');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// HOME: SLOTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SLOTS_DEF = [
  { label:'æœã”ã¯ã‚“', icon:'ğŸŒ…' },
  { label:'ã²ã‚‹ã”ã¯ã‚“', icon:'â˜€ï¸' },
  { label:'æ™©ã”ã¯ã‚“', icon:'ğŸŒ™' },
];

function renderSlots() {
  const today = new Date().toISOString().slice(0,10);
  const html  = SLOTS_DEF.map(sl => {
    const rec = records.find(r => r.date===today && r.time===sl.label);
    if (rec) {
      const emoji = { all:'å®Œé£Ÿ ğŸ˜Š', half:'å°‘ã—æ®‹ã—ãŸ ğŸ˜', no:'é£Ÿã¹ãªã‹ã£ãŸ ğŸ˜£' }[rec.reaction];
      return `<div class="slot done">
        <div class="slot-icon">${sl.icon}</div>
        <div><div class="slot-lbl">${sl.label}</div><div class="slot-name">${rec.name}</div><div class="slot-meta">${emoji}</div></div>
        <div>âœ…</div>
      </div>`;
    }
    return `<div class="slot" onclick="openRecModal('${sl.label}')">
      <div class="slot-icon">${sl.icon}</div>
      <div style="flex:1"><div class="slot-lbl">${sl.label}</div><div class="slot-name" style="font-weight:400;color:var(--sb)">ã‚¿ãƒƒãƒ—ã—ã¦è¨˜éŒ²ã™ã‚‹</div></div>
      <div style="color:var(--sb)">ï¼‹</div>
    </div>`;
  }).join('');
  document.getElementById('slots').innerHTML = html;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// AI PROPOSAL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let proposeAdopted = false;

async function runPropose() {
  const btn = document.getElementById('propose-btn');
  btn.disabled = true;
  btn.textContent = 'è€ƒãˆä¸­...';
  proposeAdopted  = false;
  document.getElementById('propose-result').innerHTML =
    `<div style="display:flex;align-items:center;gap:10px;padding-top:14px">
      <div class="dot3"><span></span><span></span><span></span></div>
      <span style="font-size:13px;opacity:.7">ç›´è¿‘3é£Ÿã‚’åˆ†æã—ã¦ã„ã¾ã™...</span>
    </div>`;

  const { stage, months } = calcStage(baby?.birth);
  const recent    = records.slice(-3);
  const recentTxt = recent.length
    ? recent.map(r=>`ãƒ»${r.time}ï¼š${r.name}ï¼ˆ${{all:'å®Œé£Ÿ',half:'å°‘ã—æ®‹ã—ãŸ',no:'é£Ÿã¹ãªã‹ã£ãŸ'}[r.reaction]}ï¼‰`).join('\n')
    : 'ãƒ»è¨˜éŒ²ãªã—';
  const stockTxt  = stocks.length ? stocks.map(s=>s.name).join('ã€') : 'ãªã—';

  try {
    const raw = await apiChat([{
      role: 'user',
      content:
        `ã‚ãªãŸã¯é›¢ä¹³é£Ÿã®ç®¡ç†æ „é¤Šå£«ã§ã™ã€‚\n` +
        `æœˆé½¢:${months}ãƒ¶æœˆ(${stage})\n` +
        `ç›´è¿‘3é£Ÿ:\n${recentTxt}\n` +
        `å†·å‡ã‚¹ãƒˆãƒƒã‚¯:${stockTxt}\n\n` +
        `ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã§æ¬¡ã®é£Ÿäº‹ã®çŒ®ç«‹ã‚’ææ¡ˆã—ã¦ãã ã•ã„ï¼š\n` +
        `- å†·å‡ã‚¹ãƒˆãƒƒã‚¯ã‚’å„ªå…ˆã—ã¦ä½¿ã†\n` +
        `- æ–°ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯1å“ã®ã¿\n` +
        `- å„ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«å¿…è¦ãªé£Ÿæã¨æœˆé½¢ã«åˆã£ãŸ1å›é‡ã®ç›®å®‰ã‚’è¨˜è¼‰\n` +
        `- ç›´è¿‘3é£Ÿã§ä¸è¶³ã—ã¦ã„ã‚‹æ „é¤Šç´ ã‚’è£œã†é£Ÿæã‚‚ææ¡ˆ\n\n` +
        `JSONã®ã¿è¿”ã—ã¦ãã ã•ã„ï¼ˆãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ä¸è¦ï¼‰ï¼š\n` +
        `{"analysis":"æ „é¤Šåˆ†æ25å­—ä»¥å†…","menu":[{"icon":"çµµæ–‡å­—","name":"æ–™ç†å","type":"stock ã¾ãŸã¯ new","ingredients":[{"name":"é£Ÿæå","amount":"1å›é‡ã®ç›®å®‰ï¼ˆä¾‹ï¼šå°ã•ã˜1ï¼‰"}]}],"warning":"åˆé£Ÿææ³¨æ„ã¾ãŸã¯null","nutritionSuggestion":{"missing":"ä¸è¶³æ „é¤Šç´ ï¼ˆä¾‹ï¼šé‰„åˆ†ãƒ»ã‚«ãƒ«ã‚·ã‚¦ãƒ ï¼‰","foods":[{"icon":"çµµæ–‡å­—","name":"é£Ÿæå","amount":"1å›é‡ç›®å®‰","reason":"è£œãˆã‚‹ç†ç”±10å­—ä»¥å†…"}]}}`
    }]);
    renderProposal(parseJSON(raw));
  } catch(e) {
    document.getElementById('propose-result').innerHTML =
      `<div class="err-box">
        <div class="err-title">âŒ ã‚¨ãƒ©ãƒ¼è©³ç´°</div>
        <div class="err-pre">${e.message}</div>
        <button class="ai-btn" style="margin-top:10px;padding:8px 0;font-size:12px" onclick="runPropose()">ğŸ”„ å†è©¦è¡Œ</button>
      </div>`;
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'âœ¨ çŒ®ç«‹ã‚’ææ¡ˆã—ã¦ã‚‚ã‚‰ã†';
  }
}

function renderProposal(d) {
  const menu = (d.menu||[]).map(m => {
    const ingredients = (m.ingredients||[]).map(i=>`${i.name} ${i.amount}`).join('ãƒ»');
    return `<div class="menu-row">
      <div class="menu-icon">${m.icon}</div>
      <div class="menu-info">
        <div class="menu-name">${m.name}</div>
        ${ingredients ? `<div class="menu-ingredients">é£Ÿæï¼š${ingredients}</div>` : ''}
      </div>
      <span class="tag ${m.type==='new'?'tag-new':'tag-stock'}">${m.type==='new'?'æ–°ãƒ¡ãƒ‹ãƒ¥ãƒ¼':'å†·å‡ã‚¹ãƒˆãƒƒã‚¯'}</span>
    </div>`;
  }).join('');

  const ns = d.nutritionSuggestion;
  let nutrSuggestHtml = '';
  if (ns && ns.foods && ns.foods.length) {
    const items = ns.foods.map(f=>
      `<div class="suggest-item">
        <span style="font-size:18px;flex-shrink:0">${f.icon}</span>
        <div>
          <div class="suggest-food">${f.name}</div>
          <div class="suggest-amount">1å›é‡ï¼š${f.amount}ã€€${f.reason}</div>
        </div>
      </div>`
    ).join('');
    nutrSuggestHtml = `
      <div class="nutr-suggest">
        <div class="nutr-suggest-title">ğŸ”‹ ä¸è¶³æ „é¤Šç´ ï¼ˆ${ns.missing}ï¼‰ã‚’è£œã†é£Ÿæ</div>
        ${items}
      </div>`;
  }

  const warn = d.warning && d.warning!=='null'
    ? `<div style="font-size:12px;opacity:.8;margin-bottom:8px">âš  ${d.warning}</div>` : '';

  document.getElementById('propose-result').innerHTML = `
    <div style="margin-top:14px">
      <div style="font-size:13px;opacity:.75;margin-bottom:10px">ğŸ“Š ${d.analysis}</div>
      <div class="proposal-box">${menu}</div>
      ${warn}
      ${nutrSuggestHtml}
      <div class="prop-btns">
        <button class="prop-btn prop-adopt" id="adopt-btn" onclick="adoptProposal()">âœ… ã“ã®çŒ®ç«‹ã‚’ä½¿ã†</button>
        <button class="prop-btn prop-retry" onclick="runPropose()">ğŸ”„ åˆ¥ã®ææ¡ˆ</button>
      </div>
    </div>`;
}

function adoptProposal() {
  const btn = document.getElementById('adopt-btn');
  if (btn) { btn.textContent='âœ… æ¡ç”¨æ¸ˆã¿'; btn.disabled=true; btn.classList.add('done'); }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RECORD MODAL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let recReaction = 'all';
let recPhoto    = null;

function openRecModal(preset) {
  recReaction = 'all';
  recPhoto    = null;
  document.getElementById('rec-name').value = '';
  document.getElementById('photo-area').innerHTML =
    '<div style="font-size:32px;margin-bottom:6px">ğŸ“·</div><p style="font-size:13px;color:var(--sb)">ã‚¿ãƒƒãƒ—ã—ã¦å†™çœŸã‚’é¸ã¶<br><span style="font-size:11px;color:var(--g)">AIãŒé£Ÿæãƒ»æ „é¤Šã‚’è‡ªå‹•è§£æã—ã¾ã™</span></p>';
  document.getElementById('vision-result').innerHTML = '';
  document.getElementById('photo-input').value = '';
  ['all','half','no'].forEach(v => {
    document.getElementById('r-'+v).classList.toggle('sel', v==='all');
  });
  if (preset) document.getElementById('rec-time').value = preset;
  document.getElementById('rec-modal').classList.remove('hide');
}

function closeRecModal() {
  document.getElementById('rec-modal').classList.add('hide');
}

function selReact(v) {
  recReaction = v;
  ['all','half','no'].forEach(r => document.getElementById('r-'+r).classList.toggle('sel', r===v));
}

async function handlePhoto(e) {
  const file = e.target.files?.[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async ev => {
    const url   = ev.target.result;
    const b64   = url.split(',')[1];
    const mtype = url.match(/data:([^;]+)/)[1];
    recPhoto    = url;
    document.getElementById('photo-area').innerHTML =
      `<img src="${url}" style="width:90px;height:90px;object-fit:cover;border-radius:10px">`;
    document.getElementById('vision-result').innerHTML =
      `<div style="background:var(--gp);border-radius:10px;padding:12px;display:flex;align-items:center;gap:9px;margin-top:8px">
        <div class="dot3"><span></span><span></span><span></span></div>
        <span style="font-size:13px;color:var(--g);font-weight:700">AIãŒå†™çœŸã‚’è§£æä¸­...</span>
      </div>`;
    try {
      const raw  = await apiVision(b64, mtype);
      const json = parseJSON(raw);
      if (json.dishName && !document.getElementById('rec-name').value) {
        document.getElementById('rec-name').value = json.dishName;
      }
      renderNutrCard(json);
    } catch(e) {
      document.getElementById('vision-result').innerHTML =
        `<div style="background:var(--op);border-radius:10px;padding:12px;margin-top:8px">
          <div style="font-size:12px;font-weight:700;color:var(--or);margin-bottom:6px">âŒ å†™çœŸè§£æã‚¨ãƒ©ãƒ¼</div>
          <pre style="font-size:11px;color:var(--sb);white-space:pre-wrap;word-break:break-all;font-family:monospace">${e.message}</pre>
          <div style="font-size:11px;color:var(--sb);margin-top:6px">æ–™ç†åã‚’æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>
        </div>`;
    }
  };
  reader.readAsDataURL(file);
}

function renderNutrCard(n) {
  const items = [
    ['ã‚¿ãƒ³ãƒ‘ã‚¯è³ª', n.nutrition?.protein],
    ['é‰„åˆ†',       n.nutrition?.iron],
    ['ç‚­æ°´åŒ–ç‰©',   n.nutrition?.carbs],
    ['ã‚«ãƒ«ã‚·ã‚¦ãƒ ', n.nutrition?.calcium],
  ];
  const col = v => v>=60?'var(--g)':v>=40?'#d97706':'var(--or)';
  const lbl = v => v>=60?'è‰¯å¥½':v>=40?'æ™®é€š':'ã‚„ã‚„ä¸è¶³';
  const bars = items.map(([l,v])=>`
    <div class="nutr-row">
      <div class="nutr-hd"><span>${l}</span><span style="color:var(--sb)">${lbl(v??0)}</span></div>
      <div class="nutr-track"><div class="nutr-fill" style="width:${v??0}%;background:linear-gradient(90deg,${col(v??0)},${col(v??0)}bb)"></div></div>
    </div>`).join('');

  const missing = (n.missingNutrients||[]).join('ãƒ»');
  document.getElementById('vision-result').innerHTML = `
    <div class="nutr-card" style="margin-top:10px">
      <div style="font-size:12px;font-weight:700;color:var(--g);margin-bottom:10px">ğŸ” AIæ „é¤Šè§£æçµæœ</div>
      ${bars}
      ${missing ? `<div style="font-size:12px;color:var(--or);margin-top:6px">âš  ä¸è¶³ãŒæ°—ã«ãªã‚‹æ „é¤Šç´ ï¼š${missing}</div>` : ''}
      <div style="font-size:12px;color:var(--or);margin-top:8px">ğŸ’¡ ${n.advice}</div>
      <div style="font-size:10px;color:var(--sb);margin-top:3px">â€»AIã«ã‚ˆã‚‹æ¨å®šå€¤ã§ã™ã€‚åŒ»ç™‚çš„åˆ¤æ–­ã«ã¯ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚</div>
    </div>`;
}

function saveRecord() {
  const name = document.getElementById('rec-name').value.trim();
  if (!name) { alert('æ–™ç†åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const time = document.getElementById('rec-time').value;
  const date = new Date().toISOString().slice(0,10);
  records.push({ id:Date.now(), date, time, name, reaction:recReaction, photo:recPhoto });
  save();
  closeRecModal();
  renderSlots();
  renderRecords();
  goPage('home');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RECORDS PAGE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderRecords() {
  const today = new Date().toISOString().slice(0,10);
  const yest  = new Date(); yest.setDate(yest.getDate()-1);
  const yestS = yest.toISOString().slice(0,10);
  const RLBL  = { all:'å®Œé£Ÿ', half:'å°‘ã—æ®‹ã—ãŸ', no:'é£Ÿã¹ãªã‹ã£ãŸ' };
  const RCLS  = { all:'r-all', half:'r-half', no:'r-no' };
  const TICON = { æœã”ã¯ã‚“:'ğŸŒ…', ã²ã‚‹ã”ã¯ã‚“:'â˜€ï¸', æ™©ã”ã¯ã‚“:'ğŸŒ™', ãŠã‚„ã¤:'ğŸª' };

  if (!records.length) {
    document.getElementById('rec-list').innerHTML =
      '<div class="empty"><div class="empty-icon">ğŸ“–</div><p>ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
    return;
  }

  const groups = {};
  [...records].reverse().forEach(r => {
    if (!groups[r.date]) groups[r.date] = [];
    groups[r.date].push(r);
  });

  document.getElementById('rec-list').innerHTML = Object.entries(groups).map(([date,recs]) =>
    `<div style="margin-bottom:18px">
      <div class="day-hd">${date===today?'ä»Šæ—¥':date===yestS?'æ˜¨æ—¥':date}</div>
      ${recs.map(r=>`
        <div class="rec-item">
          <div class="rec-thumb">${r.photo?`<img src="${r.photo}" alt="">`:TICON[r.time]||'ğŸ½'}</div>
          <div style="flex:1;min-width:0">
            <div class="rec-name">${r.name}</div>
            <div class="rec-meta">${TICON[r.time]||'ğŸ½'} ${r.time}</div>
          </div>
          <div class="rbadge ${RCLS[r.reaction]}">${RLBL[r.reaction]}</div>
        </div>`).join('')}
    </div>`
  ).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STOCK
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openStockModal() {
  document.getElementById('s-emoji').value = '';
  document.getElementById('s-sname').value = '';
  document.getElementById('s-amt').value   = '';
  document.getElementById('s-date').value  = new Date().toISOString().slice(0,10);
  document.getElementById('stock-modal').classList.remove('hide');
}
function closeStockModal() {
  document.getElementById('stock-modal').classList.add('hide');
}
function saveStock() {
  const name = document.getElementById('s-sname').value.trim();
  if (!name) { alert('æ–™ç†åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  stocks.push({
    id:    Date.now(),
    emoji: document.getElementById('s-emoji').value.trim() || 'ğŸ±',
    name,
    amount:document.getElementById('s-amt').value.trim()   || 'â€”',
    date:  document.getElementById('s-date').value,
  });
  save();
  closeStockModal();
  renderStocks();
}

function renderStocks() {
  const now = new Date();
  document.getElementById('stock-count').textContent = stocks.length + 'å“';

  const warns = stocks.filter(s => {
    const e = new Date(s.date); e.setDate(e.getDate()+14);
    return Math.ceil((e-now)/86400000) <= 3;
  }).length;
  const warnMsg = document.getElementById('stock-warn-msg');
  if (warns > 0 && toggles.expiry) {
    warnMsg.style.display = 'block';
    warnMsg.textContent   = `âš  ${warns}å“ãŒä»Šé€±ä¸­ã«æœŸé™åˆ‡ã‚Œã§ã™`;
  } else {
    warnMsg.style.display = 'none';
  }

  if (!stocks.length) {
    document.getElementById('stock-grid').innerHTML  = '';
    document.getElementById('stock-empty').style.display = 'block';
    return;
  }
  document.getElementById('stock-empty').style.display = 'none';

  document.getElementById('stock-grid').innerHTML = stocks.map((s,i) => {
    const exp  = new Date(s.date); exp.setDate(exp.getDate()+14);
    const days = Math.ceil((exp-now)/86400000);
    const warn = toggles.expiry && days <= 3;
    return `<div class="stock-item${warn?' warn':''}">
      <button class="s-del" onclick="delStock(${i})">âœ•</button>
      <div class="s-emoji">${s.emoji}</div>
      <div class="s-name">${s.name}</div>
      <div class="s-amt">${s.amount}</div>
      <div class="s-exp ${warn?'s-warn':'s-ok'}">${warn?`âš  ${days}æ—¥å¾Œã«æœŸé™`:`âœ… ã‚ã¨${days}æ—¥`}</div>
    </div>`;
  }).join('');
}

function delStock(i) {
  if (!confirm('ã“ã®ã‚¹ãƒˆãƒƒã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  stocks.splice(i, 1);
  save();
  renderStocks();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SETTINGS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSettings() {
  const { stage, months } = calcStage(baby?.birth);
  const birthDisp = baby?.birth ? (() => {
    const d = new Date(baby.birth+'-01');
    return `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ`;
  })() : 'â€”';
  document.getElementById('s-name').textContent   = baby?.name || 'â€”';
  document.getElementById('s-birth').textContent  = birthDisp;
  document.getElementById('s-stage').textContent  = stage;
  document.getElementById('s-months').textContent = months + 'ãƒ¶æœˆ';
  document.getElementById('tog-first').classList.toggle('on', toggles.firstFood);
  document.getElementById('tog-exp').classList.toggle('on',   toggles.expiry);
  renderSAlls();
}

function renderSAlls() {
  document.getElementById('s-alls').innerHTML =
    allergens.map((a,i)=>`<div class="atag">${a}<button onclick="delAll(${i})">Ã—</button></div>`).join('') ||
    '<span style="font-size:13px;color:var(--sb)">ç™»éŒ²ãªã—</span>';
}
function sAddAll() {
  const v = document.getElementById('s-all-input').value.trim();
  if (!v) return;
  allergens.push(v);
  document.getElementById('s-all-input').value = '';
  save(); renderSAlls();
}
function delAll(i) {
  allergens.splice(i,1); save(); renderSAlls();
}
function editName() {
  const v = prompt('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„', baby?.name||'');
  if (v===null) return;
  if (!v.trim()) { alert('å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  baby.name = v.trim(); save(); renderHeader(); renderSettings();
}
function editBirth() {
  const v = prompt('ç”Ÿå¹´æœˆæ—¥ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ï¼ˆä¾‹: 2024-07ï¼‰', baby?.birth||'');
  if (v===null) return;
  if (!/^\d{4}-\d{2}$/.test(v)) { alert('å½¢å¼: 2024-07'); return; }
  baby.birth = v; save(); renderHeader(); renderSettings();
}
function togFirst() {
  toggles.firstFood = !toggles.firstFood; save();
  document.getElementById('tog-first').classList.toggle('on', toggles.firstFood);
}
function togExp() {
  toggles.expiry = !toggles.expiry; save();
  document.getElementById('tog-exp').classList.toggle('on', toggles.expiry);
  renderStocks();
}
function resetData() {
  if (!confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚\nã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
  ['baby','alls','recs','stocks','toggles'].forEach(k => localStorage.removeItem('bm_'+k));
  location.reload();
}

// â”€â”€ Close modals on bg click â”€â”€
document.getElementById('rec-modal').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeRecModal();
});
document.getElementById('stock-modal').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeStockModal();
});
</script>
</body>
</html>
