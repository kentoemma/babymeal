<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="theme-color" content="#4a7c59">
<title>BabyMeal</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@800;900&family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
<style>
:root{--g:#4a7c59;--gl:#6aab7a;--gp:#e8f5ec;--gm:#c5e4cc;--or:#f4845f;--op:#fde8e0;--ye:#f9c74f;--cr:#faf8f3;--tx:#2d2d2d;--sb:#7a7a7a;--wh:#ffffff}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{font-family:'Noto Sans JP',sans-serif;background:var(--cr);color:var(--tx);min-height:100vh}
#app{max-width:430px;margin:0 auto;min-height:100vh;position:relative}
#splash{position:fixed;inset:0;background:var(--g);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000;transition:opacity .5s}
#splash.hide{opacity:0;pointer-events:none}
#splash .slogo{font-size:72px;animation:bounceIn .6s ease}
#splash h1{font-family:'Nunito',sans-serif;color:#fff;font-size:34px;font-weight:900;margin-top:8px}
#splash p{color:rgba(255,255,255,.7);font-size:13px;margin-top:6px}
#onboarding{position:fixed;inset:0;background:var(--cr);z-index:900;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:28px 22px;overflow-y:auto}
#onboarding.hide{display:none}
.ob-step{display:none;width:100%;flex-direction:column;align-items:center}
.ob-step.active{display:flex}
.ob-title{font-size:24px;font-weight:900;color:var(--g);margin-bottom:8px;text-align:center}
.ob-sub{font-size:14px;color:var(--sb);text-align:center;margin-bottom:22px;line-height:1.6}
#header{position:sticky;top:0;z-index:100;background:var(--wh);padding:12px 18px 10px;border-bottom:1px solid var(--gm);display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 12px rgba(74,124,89,.08)}
.hlogo{font-family:'Nunito',sans-serif;font-weight:900;font-size:20px;color:var(--g)}
.stage-badge{background:var(--gp);color:var(--g);font-size:11px;font-weight:700;padding:3px 10px;border-radius:20px}
#nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;background:var(--wh);border-top:1px solid var(--gm);display:flex;z-index:100;padding-bottom:env(safe-area-inset-bottom)}
.nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;padding:9px 4px 7px;cursor:pointer;border:none;background:none;color:var(--sb);font-size:10px;font-weight:700;gap:2px;font-family:inherit;transition:color .2s}
.nav-btn .ni{font-size:20px;transition:transform .2s}
.nav-btn.active{color:var(--g)}
.nav-btn.active .ni{transform:scale(1.15)}
.page{display:none;padding:14px 14px 90px;animation:fadeUp .25s ease}
.page.active{display:block}
.card{background:var(--wh);border-radius:18px;padding:18px;box-shadow:0 4px 20px rgba(74,124,89,.1);margin-bottom:14px}
.ctitle{font-size:11px;font-weight:700;color:var(--sb);text-transform:uppercase;letter-spacing:.6px;margin-bottom:12px}
.sec{font-size:17px;font-weight:900;margin-bottom:13px}
.hero{background:linear-gradient(135deg,var(--g),var(--gl));border-radius:18px;padding:22px 18px;margin-bottom:14px;color:#fff;position:relative;overflow:hidden}
.hero::before{content:'ğŸ¼';position:absolute;right:14px;top:50%;transform:translateY(-50%);font-size:58px;opacity:.18}
.hero .hdate{font-size:12px;opacity:.75;margin-bottom:4px}
.hero h2{font-size:19px;font-weight:900;margin-bottom:3px}
.hero p{font-size:13px;opacity:.82}
.slot{border:2px dashed var(--gm);border-radius:12px;padding:13px 14px;margin-bottom:9px;cursor:pointer;display:flex;align-items:center;gap:11px}
.slot.done{border:2px solid var(--gm);background:var(--gp);cursor:default}
.btn{width:100%;border:none;border-radius:12px;padding:13px;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;display:flex;align-items:center;justify-content:center;gap:7px}
.btn-g{background:var(--g);color:#fff}
.btn-ol{background:var(--gp);color:var(--g);border:2px solid var(--gm)}
.btn-danger{background:#fee2e2;color:#991b1b}
.f2{display:flex;gap:9px}
.f2 .btn{flex:1}
.ai-card{background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:18px;padding:18px;margin-bottom:14px;color:#fff}
.ai-badge{display:inline-flex;align-items:center;gap:5px;background:rgba(255,255,255,.15);border-radius:20px;padding:3px 11px;font-size:11px;font-weight:700;margin-bottom:12px}
.ai-pulse{width:6px;height:6px;background:#4ade80;border-radius:50%;animation:pulse 2s infinite;display:inline-block}
.ai-btn{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.3);border-radius:12px;padding:13px;font-size:14px;font-weight:700;color:#fff;cursor:pointer;width:100%;font-family:inherit;display:flex;align-items:center;justify-content:center;gap:7px}
.ai-btn:disabled{opacity:.5;cursor:default}
.dot3 span{width:7px;height:7px;background:var(--gl);border-radius:50%;display:inline-block;animation:bounce 1.2s infinite;margin:0 2px}
.dot3 span:nth-child(2){animation-delay:.2s}
.dot3 span:nth-child(3){animation-delay:.4s}
.pbox{background:rgba(255,255,255,.08);border-radius:12px;padding:12px;margin:12px 0}
.mrow{display:flex;align-items:flex-start;gap:9px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.07)}
.mrow:last-child{border-bottom:none}
.mname{font-size:14px;font-weight:700}
.ming{font-size:11px;opacity:.7;margin-top:3px;line-height:1.6}
.tag{font-size:10px;padding:2px 8px;border-radius:10px;font-weight:700;flex-shrink:0}
.tag-new{background:rgba(249,199,79,.2);color:var(--ye)}
.tag-stk{background:rgba(74,222,128,.15);color:#4ade80}
.nsugg{background:rgba(255,255,255,.06);border-radius:12px;padding:12px;margin-top:10px}
.nsugg-t{font-size:12px;font-weight:700;opacity:.8;margin-bottom:8px}
.sitem{display:flex;align-items:flex-start;gap:7px;padding:5px 0;border-bottom:1px solid rgba(255,255,255,.05)}
.sitem:last-child{border-bottom:none}
.pbtns{display:flex;gap:8px;margin-top:12px}
.pbtn{flex:1;border-radius:10px;padding:10px;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;border:1px solid rgba(255,255,255,.3)}
.pbtn-a{background:rgba(74,222,128,.2);color:#4ade80}
.pbtn-a:disabled{cursor:default;opacity:.7}
.pbtn-r{background:transparent;color:rgba(255,255,255,.7)}
.ebox{background:rgba(244,132,95,.18);border:1px solid rgba(244,132,95,.5);border-radius:10px;padding:12px;margin-top:12px}
.ebox-t{font-size:12px;font-weight:700;color:var(--or);margin-bottom:6px}
.ebox-p{font-size:11px;color:rgba(255,255,255,.7);white-space:pre-wrap;word-break:break-all;font-family:monospace;line-height:1.5}
.dayhd{font-size:12px;font-weight:700;color:var(--sb);margin-bottom:9px;display:flex;align-items:center;gap:7px}
.dayhd::after{content:'';flex:1;height:1px;background:var(--gm)}
.ritem{background:var(--wh);border-radius:12px;padding:13px 14px;margin-bottom:8px;display:flex;align-items:center;gap:11px;box-shadow:0 2px 8px rgba(74,124,89,.07)}
.rthumb{width:50px;height:50px;border-radius:9px;background:var(--gp);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;overflow:hidden}
.rthumb img{width:100%;height:100%;object-fit:cover}
.rname{font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.rmeta{font-size:12px;color:var(--sb);margin-top:2px}
.rbadge{font-size:11px;padding:3px 9px;border-radius:20px;font-weight:700;white-space:nowrap}
.r-all{background:#dcfce7;color:#15803d}
.r-half{background:#fef9c3;color:#854d0e}
.r-no{background:#fee2e2;color:#991b1b}
.sgrid{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:14px}
.scard{background:var(--wh);border-radius:12px;padding:13px;box-shadow:0 2px 8px rgba(74,124,89,.07);position:relative}
.scard.warn{border:2px solid var(--or);background:var(--op)}
.sdel{position:absolute;top:7px;right:7px;background:none;border:none;font-size:14px;cursor:pointer;opacity:.35;line-height:1}
.mbg{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;display:flex;align-items:flex-end;backdrop-filter:blur(4px)}
.mbg.hide{display:none}
.modal{background:var(--wh);border-radius:22px 22px 0 0;padding:22px 18px 36px;width:100%;max-width:430px;margin:0 auto;max-height:90vh;overflow-y:auto;animation:slideUp .28s ease}
.mhandle{width:38px;height:4px;background:var(--gm);border-radius:2px;margin:0 auto 18px}
.modal h3{font-size:17px;font-weight:900;margin-bottom:18px}
.fg{margin-bottom:14px}
.fl{font-size:13px;font-weight:700;color:var(--sb);margin-bottom:5px;display:block}
.fi{width:100%;border:2px solid var(--gm);border-radius:12px;padding:11px 13px;font-size:14px;font-family:inherit;outline:none;background:var(--wh);transition:border-color .2s}
.fi:focus{border-color:var(--g)}
.photo-area{border:2px dashed var(--gm);border-radius:12px;padding:20px;text-align:center;cursor:pointer;background:var(--gp);margin-bottom:10px}
.rrow{display:flex;gap:7px}
.ropt{flex:1;padding:9px;border:2px solid var(--gm);border-radius:12px;text-align:center;cursor:pointer;font-size:12px;font-weight:700;background:var(--wh)}
.ropt.sel{border-color:var(--g);background:var(--gp);color:var(--g)}
.ropt-e{font-size:19px;display:block;margin-bottom:3px}
.ncrd{background:var(--gp);border-radius:10px;padding:14px;margin-top:10px}
.nrow{margin-bottom:9px}
.nhd{display:flex;justify-content:space-between;margin-bottom:3px;font-size:12px;font-weight:600}
.ntrack{height:8px;background:#d1fae5;border-radius:4px;overflow:hidden}
.nfill{height:100%;border-radius:4px;transition:width 1s ease}
.srow{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--gp)}
.srow:last-child{border-bottom:none}
.tog{width:46px;height:25px;background:var(--gm);border-radius:13px;position:relative;cursor:pointer;transition:background .2s;flex-shrink:0;border:none}
.tog.on{background:var(--g)}
.tog::after{content:'';position:absolute;top:3px;left:3px;width:19px;height:19px;background:#fff;border-radius:50%;transition:transform .2s;box-shadow:0 2px 4px rgba(0,0,0,.18)}
.tog.on::after{transform:translateX(21px)}
.atag-wrap{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:11px;min-height:28px}
.atag{background:var(--op);color:var(--or);font-size:12px;font-weight:700;padding:4px 11px;border-radius:20px;display:flex;align-items:center;gap:5px}
.atag button{background:none;border:none;cursor:pointer;font-size:13px;line-height:1;color:var(--or);padding:0}
.empty{text-align:center;padding:40px 18px;color:var(--sb)}
.ei{font-size:46px;margin-bottom:10px}
.fcat{font-size:11px;font-weight:700;color:var(--sb);margin:12px 0 6px;text-transform:uppercase;letter-spacing:.5px}
.fchips{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:4px}
.fchip{padding:6px 12px;border-radius:20px;font-size:13px;font-weight:700;cursor:pointer;border:2px solid var(--gm);background:var(--wh);color:var(--tx);transition:all .15s;user-select:none}
.fchip.sel{background:var(--g);color:#fff;border-color:var(--g)}
.etag{background:var(--gp);color:var(--g);font-size:12px;font-weight:700;padding:4px 11px;border-radius:20px;display:flex;align-items:center;gap:5px;cursor:pointer}
.etag-x{font-size:12px;line-height:1}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
@keyframes bounceIn{from{transform:scale(.3);opacity:0}to{transform:scale(1);opacity:1}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
@keyframes bounce{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-7px)}}
</style>
</head>
<body>
<div id="app">

<div id="splash">
  <div class="slogo">ğŸ¼</div>
  <h1>BabyMeal</h1>
  <p>èµ¤ã¡ã‚ƒã‚“ã®é£Ÿäº‹ã‚’ã€ã‚‚ã£ã¨ã‹ã‚“ãŸã‚“ã«</p>
</div>

<div id="onboarding" class="hide">
  <!-- STEP 1 -->
  <div class="ob-step active" id="ob1">
    <div style="font-size:56px;margin-bottom:14px">ğŸ‘¶</div>
    <div class="ob-title">ã¯ã˜ã‚ã¾ã—ã¦ï¼</div>
    <div class="ob-sub">èµ¤ã¡ã‚ƒã‚“ã®æƒ…å ±ã‚’æ•™ãˆã¦ãã ã•ã„<br>ã‚ã¨ã‹ã‚‰è¨­å®šã§å¤‰æ›´ã§ãã¾ã™</div>
    <div style="width:100%">
      <div class="fg"><label class="fl">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </label><input class="fi" id="ob-name" placeholder="ä¾‹ï¼šã¯ã‚‹ãã‚“"></div>
      <div class="fg"><label class="fl">ç”Ÿå¹´æœˆæ—¥ï¼ˆå¹´æœˆï¼‰</label><input type="month" class="fi" id="ob-birth"></div>
    </div>
    <button class="btn btn-g" onclick="obStep1Next()">æ¬¡ã¸ â†’</button>
  </div>

  <!-- STEP 2 -->
  <div class="ob-step" id="ob2">
    <div style="font-size:56px;margin-bottom:14px">âš ï¸</div>
    <div class="ob-title">ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼é£Ÿæ</div>
    <div class="ob-sub">é™¤å»ãƒ»æœªç¢ºèªã®é£ŸæãŒã‚ã‚Œã°å…¥åŠ›ã—ã¦ãã ã•ã„<br>ï¼ˆå¾Œã‹ã‚‰è¨­å®šã§å¤‰æ›´ã§ãã¾ã™ï¼‰</div>
    <div style="width:100%;margin-bottom:16px">
      <div class="atag-wrap" id="ob-alls"></div>
      <div style="display:flex;gap:8px">
        <input class="fi" id="ob-all-input" placeholder="ä¾‹ï¼šåµã€ãˆã³" style="flex:1" onkeydown="if(event.key==='Enter')obAddAll()">
        <button class="btn btn-ol" style="width:auto;padding:0 14px" onclick="obAddAll()">è¿½åŠ </button>
      </div>
    </div>
    <button class="btn btn-g" onclick="obStep2Next()">æ¬¡ã¸ â†’</button>
    <button class="btn btn-ol" style="margin-top:8px" onclick="obStep2Next()">ã‚¹ã‚­ãƒƒãƒ—</button>
  </div>

  <!-- STEP 3 -->
  <div class="ob-step" id="ob3">
    <div style="font-size:56px;margin-bottom:14px">ğŸ¥—</div>
    <div class="ob-title">é£Ÿã¹ãŸã“ã¨ã‚ã‚‹é£Ÿæ</div>
    <div class="ob-sub">ã“ã‚Œã¾ã§é£Ÿã¹ãŸã“ã¨ãŒã‚ã‚‹é£Ÿæã‚’é¸ã‚“ã§ãã ã•ã„<br>åˆé£Ÿæã®åˆ¤å®šã¨çŒ®ç«‹ææ¡ˆã«ä½¿ã„ã¾ã™</div>
    <div style="width:100%;max-height:50vh;overflow-y:auto;margin-bottom:16px" id="ob-food-list"></div>
    <button class="btn btn-g" onclick="obFinish()">ğŸ‰ ã¯ã˜ã‚ã‚‹</button>
    <button class="btn btn-ol" style="margin-top:8px" onclick="obFinish()">ã‚¹ã‚­ãƒƒãƒ—</button>
  </div>
</div>

<div id="header" style="display:none">
  <div class="hlogo">ğŸ¼ BabyMeal</div>
  <div style="text-align:right">
    <div style="font-size:13px;color:var(--sb)" id="hd-name">ğŸ‘¶ â€”</div>
    <div class="stage-badge" id="hd-stage">â€”</div>
  </div>
</div>

<!-- HOME -->
<div id="pg-home" class="page active">
  <div class="hero">
    <div class="hdate" id="today-str"></div>
    <h2>ä»Šæ—¥ã®é›¢ä¹³é£Ÿ ğŸ“‹</h2>
    <p>3é£Ÿã®è¨˜éŒ²ã¨çŒ®ç«‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã‚ˆã†</p>
  </div>
  <div class="card">
    <div class="ctitle">ä»Šæ—¥ã®é£Ÿäº‹è¨˜éŒ²</div>
    <div id="slots"></div>
  </div>
  <div class="ai-card">
    <div class="ai-badge"><span class="ai-pulse"></span>AIææ¡ˆ</div>
    <div style="font-size:15px;font-weight:900;margin-bottom:10px">æ¬¡å›ã®çŒ®ç«‹ã‚’ææ¡ˆã™ã‚‹</div>
    <p style="font-size:13px;opacity:.7;margin-bottom:14px;line-height:1.6">ç›´è¿‘3é£Ÿãƒ»ã‚¹ãƒˆãƒƒã‚¯ãƒ»é£Ÿã¹æ…£ã‚ŒãŸé£Ÿæã‚’ã‚‚ã¨ã«AIãŒçŒ®ç«‹ã¨1å›é‡ã‚’ææ¡ˆã—ã¾ã™</p>
    <button class="ai-btn" id="propose-btn" onclick="runPropose()">âœ¨ çŒ®ç«‹ã‚’ææ¡ˆã—ã¦ã‚‚ã‚‰ã†</button>
    <div id="propose-result"></div>
  </div>
</div>

<!-- RECORD -->
<div id="pg-record" class="page">
  <div class="sec">ğŸ“– é£Ÿäº‹è¨˜éŒ²</div>
  <div id="rec-list"></div>
  <button class="btn btn-g" onclick="openRecModal(null)">ï¼‹ é£Ÿäº‹ã‚’è¨˜éŒ²ã™ã‚‹</button>
</div>

<!-- STOCK -->
<div id="pg-stock" class="page">
  <div class="sec">ğŸ§Š å†·å‡ã‚¹ãƒˆãƒƒã‚¯</div>
  <div class="card" style="padding:12px 16px;margin-bottom:10px">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div style="font-size:13px;font-weight:700;color:var(--sb)">ç¾åœ¨ã®åœ¨åº«</div>
      <div style="font-size:22px;font-weight:900;color:var(--g)" id="stock-count">0å“</div>
    </div>
    <div id="stock-warn-msg" style="font-size:12px;color:var(--or);margin-top:4px;display:none"></div>
  </div>
  <div class="sgrid" id="stock-grid"></div>
  <div id="stock-empty" class="empty" style="display:none"><div class="ei">ğŸ§Š</div><p>å†·å‡ã‚¹ãƒˆãƒƒã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</p></div>
  <button class="btn btn-g" onclick="openStockModal()">ï¼‹ ã‚¹ãƒˆãƒƒã‚¯ã‚’è¿½åŠ ã™ã‚‹</button>
</div>

<!-- SETTINGS -->
<div id="pg-settings" class="page">
  <div class="sec">âš™ï¸ è¨­å®š</div>
  <div class="card">
    <div class="ctitle">èµ¤ã¡ã‚ƒã‚“æƒ…å ±</div>
    <div class="srow"><div style="font-weight:700;font-size:15px">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </div><div><span style="font-size:14px;color:var(--g);font-weight:700" id="s-name">â€”</span><span style="font-size:12px;color:var(--g);cursor:pointer;text-decoration:underline;margin-left:8px" onclick="editName()">å¤‰æ›´</span></div></div>
    <div class="srow"><div style="font-weight:700;font-size:15px">ç”Ÿå¹´æœˆæ—¥</div><div><span style="font-size:14px;color:var(--g);font-weight:700" id="s-birth">â€”</span><span style="font-size:12px;color:var(--g);cursor:pointer;text-decoration:underline;margin-left:8px" onclick="editBirth()">å¤‰æ›´</span></div></div>
    <div class="srow"><div style="font-weight:700;font-size:15px">ã‚¹ãƒ†ãƒ¼ã‚¸</div><span style="font-size:14px;color:var(--g);font-weight:700" id="s-stage">â€”</span></div>
    <div class="srow" style="border:none"><div style="font-weight:700;font-size:15px">æœˆé½¢</div><span style="font-size:14px;color:var(--g);font-weight:700" id="s-months">â€”</span></div>
  </div>
  <div class="card">
    <div class="ctitle">ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ãƒ»é™¤å»é£Ÿæ</div>
    <div class="atag-wrap" id="s-alls"></div>
    <div style="display:flex;gap:8px">
      <input class="fi" id="s-all-input" placeholder="é£Ÿæåã‚’å…¥åŠ›" style="flex:1;font-size:14px;padding:10px 12px" onkeydown="if(event.key==='Enter')sAddAll()">
      <button class="btn btn-ol" style="width:auto;padding:0 14px" onclick="sAddAll()">è¿½åŠ </button>
    </div>
  </div>
  <div class="card">
    <div class="ctitle">é£Ÿã¹ãŸã“ã¨ã‚ã‚‹é£Ÿæ</div>
    <p style="font-size:12px;color:var(--sb);margin-bottom:10px">çŒ®ç«‹ææ¡ˆã¨åˆé£Ÿæã‚¢ãƒ©ãƒ¼ãƒˆã«ä½¿ã„ã¾ã™ã€‚ã‚¿ãƒƒãƒ—ã§å‰Šé™¤ã§ãã¾ã™ã€‚</p>
    <div class="atag-wrap" id="s-eaten"></div>
    <div style="display:flex;gap:8px">
      <input class="fi" id="s-eaten-input" placeholder="é£Ÿæåã‚’è¿½åŠ " style="flex:1;font-size:14px;padding:10px 12px" onkeydown="if(event.key==='Enter')sAddEaten()">
      <button class="btn btn-ol" style="width:auto;padding:0 14px" onclick="sAddEaten()">è¿½åŠ </button>
    </div>
  </div>
  <div class="card">
    <div class="ctitle">è¡¨ç¤ºè¨­å®š</div>
    <div class="srow">
      <div><div style="font-weight:700;font-size:15px">åˆé£Ÿæã‚¢ãƒ©ãƒ¼ãƒˆ</div><div style="font-size:12px;color:var(--sb);margin-top:2px">åˆã‚ã¦ã®é£Ÿæã‚’ä½¿ã†éš›ã«è¡¨ç¤º</div></div>
      <button class="tog" id="tog-first" onclick="togFirst()"></button>
    </div>
    <div class="srow" style="border:none">
      <div><div style="font-weight:700;font-size:15px">å†·å‡æœŸé™ã‚¢ãƒ©ãƒ¼ãƒˆ</div><div style="font-size:12px;color:var(--sb);margin-top:2px">æœŸé™3æ—¥å‰ã«è­¦å‘Šè¡¨ç¤º</div></div>
      <button class="tog" id="tog-exp" onclick="togExp()"></button>
    </div>
  </div>
  <div class="card">
    <div class="ctitle" style="color:#991b1b">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</div>
    <button class="btn btn-danger" onclick="resetData()">ğŸ—‘ ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
</div>

<nav id="nav" style="display:none">
  <button class="nav-btn active" onclick="goPage('home')" id="nb-home"><span class="ni">ğŸ </span>ãƒ›ãƒ¼ãƒ </button>
  <button class="nav-btn" onclick="goPage('record')" id="nb-record"><span class="ni">ğŸ“–</span>è¨˜éŒ²</button>
  <button class="nav-btn" onclick="goPage('stock')" id="nb-stock"><span class="ni">ğŸ§Š</span>å†·å‡</button>
  <button class="nav-btn" onclick="goPage('settings')" id="nb-settings"><span class="ni">âš™ï¸</span>è¨­å®š</button>
</nav>

<!-- RECORD MODAL -->
<div class="mbg hide" id="rec-modal">
  <div class="modal">
    <div class="mhandle"></div>
    <h3>é£Ÿäº‹ã‚’è¨˜éŒ²ã™ã‚‹</h3>
    <div class="fg">
      <label class="fl">ğŸ“¸ å†™çœŸï¼ˆAIæ „é¤Šè§£æï¼‰</label>
      <div class="photo-area" id="photo-area" onclick="document.getElementById('photo-input').click()">
        <div style="font-size:32px;margin-bottom:6px">ğŸ“·</div>
        <p style="font-size:13px;color:var(--sb)">ã‚¿ãƒƒãƒ—ã—ã¦å†™çœŸã‚’é¸ã¶<br><span style="font-size:11px;color:var(--g)">AIãŒé£Ÿæãƒ»æ „é¤Šã‚’è‡ªå‹•è§£æã—ã¾ã™</span></p>
      </div>
      <input type="file" id="photo-input" accept="image/*" style="display:none" onchange="handlePhoto(event)">
      <div id="vision-result"></div>
    </div>
    <div class="fg">
      <label class="fl">ğŸ• é£Ÿäº‹ã®æ™‚é–“å¸¯</label>
      <select class="fi" id="rec-time">
        <option value="æœã”ã¯ã‚“">ğŸŒ… æœã”ã¯ã‚“</option>
        <option value="ã²ã‚‹ã”ã¯ã‚“">â˜€ï¸ ã²ã‚‹ã”ã¯ã‚“</option>
        <option value="æ™©ã”ã¯ã‚“">ğŸŒ™ æ™©ã”ã¯ã‚“</option>
        <option value="ãŠã‚„ã¤">ğŸª ãŠã‚„ã¤</option>
      </select>
    </div>
    <div class="fg">
      <label class="fl">ğŸ½ æ–™ç†å</label>
      <input class="fi" id="rec-name" placeholder="ä¾‹ï¼šã‹ã¼ã¡ã‚ƒãƒšãƒ¼ã‚¹ãƒˆãƒ»è±†è…">
      <button class="btn btn-ol" style="margin-top:8px;font-size:13px;padding:9px" onclick="reanalyze()">ğŸ”„ ã“ã®å†…å®¹ã§æ „é¤Šã‚’å†è§£æã™ã‚‹</button>
    </div>
    <div class="fg">
      <label class="fl">ğŸ˜Š é£Ÿã¹ãŸé‡ãƒ»åå¿œ</label>
      <div class="rrow">
        <div class="ropt sel" onclick="selReact('all')" id="r-all"><span class="ropt-e">ğŸ˜Š</span>å®Œé£Ÿ</div>
        <div class="ropt" onclick="selReact('half')" id="r-half"><span class="ropt-e">ğŸ˜</span>å°‘ã—æ®‹ã—ãŸ</div>
        <div class="ropt" onclick="selReact('no')" id="r-no"><span class="ropt-e">ğŸ˜£</span>é£Ÿã¹ãªã‹ã£ãŸ</div>
      </div>
    </div>
    <div class="f2">
      <button class="btn btn-ol" onclick="closeRecModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-g" onclick="saveRecord()">ğŸ’¾ ä¿å­˜ã™ã‚‹</button>
    </div>
  </div>
</div>

<!-- STOCK MODAL -->
<div class="mbg hide" id="stock-modal">
  <div class="modal">
    <div class="mhandle"></div>
    <h3>ğŸ§Š ã‚¹ãƒˆãƒƒã‚¯ã‚’è¿½åŠ </h3>
    <div class="fg"><label class="fl">çµµæ–‡å­—ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆä»»æ„ï¼‰</label><input class="fi" id="sm-emoji" placeholder="ä¾‹ï¼šğŸƒ" maxlength="2"></div>
    <div class="fg"><label class="fl">æ–™ç†å</label><input class="fi" id="sm-name" placeholder="ä¾‹ï¼šã‹ã¼ã¡ã‚ƒãƒšãƒ¼ã‚¹ãƒˆ"></div>
    <div class="fg"><label class="fl">é‡</label><input class="fi" id="sm-amt" placeholder="ä¾‹ï¼šè£½æ°·çš¿5ãƒã‚¹"></div>
    <div class="fg"><label class="fl">èª¿ç†æ—¥</label><input type="date" class="fi" id="sm-date"></div>
    <div class="f2">
      <button class="btn btn-ol" onclick="closeStockModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-g" onclick="saveStock()">è¿½åŠ ã™ã‚‹</button>
    </div>
  </div>
</div>

</div><!-- #app -->
<script>
// =============================================
// DATA
// =============================================
var FOOD_CATS = [
  {cat:'ğŸŒ¾ ç©€é¡ãƒ»èŠ‹é¡', foods:['ãŠã‹ã‚†','ã†ã©ã‚“','ãã†ã‚ã‚“','ãƒ‘ãƒ³','ã‚³ãƒ¼ãƒ³ãƒ•ãƒ¬ãƒ¼ã‚¯','ã˜ã‚ƒãŒã„ã‚‚','ã•ã¤ã¾ã„ã‚‚','ã‹ã¼ã¡ã‚ƒ','ã¨ã†ã‚‚ã‚ã“ã—']},
  {cat:'ğŸŸ é­šä»‹é¡', foods:['ç™½èº«é­š','é®­','ã¾ãã‚','ãƒ„ãƒŠç¼¶','ã—ã‚‰ã™','ã‚«ãƒ¬ã‚¤','ã‚¿ã‚¤','ãƒ–ãƒª']},
  {cat:'ğŸ¥© è‚‰é¡', foods:['é¶ã²ãè‚‰','é¶ã•ã•ã¿','è±šã²ãè‚‰','ç‰›ã²ãè‚‰','ãƒ¬ãƒãƒ¼']},
  {cat:'ğŸ¥š åµãƒ»è±†é¡', foods:['åµé»„','å…¨åµ','è±†è…','ç´è±†','ããªç²‰','æè±†','å¤§è±†']},
  {cat:'ğŸ¥› ä¹³è£½å“', foods:['æ¯ä¹³ãƒ»ãƒŸãƒ«ã‚¯','ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ','ã‚«ãƒƒãƒ†ãƒ¼ã‚¸ãƒãƒ¼ã‚º','ç‰›ä¹³ï¼ˆæ–™ç†ç”¨ï¼‰','ç²‰ãƒãƒ¼ã‚º']},
  {cat:'ğŸ¥¦ é‡èœ', foods:['ã«ã‚“ã˜ã‚“','ã»ã†ã‚Œã‚“è‰','å°æ¾èœ','ãƒ–ãƒ­ãƒƒã‚³ãƒªãƒ¼','ç‰ã­ã','ãƒˆãƒãƒˆ','ãã‚…ã†ã‚Š','ã‚­ãƒ£ãƒ™ãƒ„','ç™½èœ','ãªã™','ãƒ”ãƒ¼ãƒãƒ³','é•·ã­ã','å¤§æ ¹','ã‚Œã‚“ã“ã‚“','ã”ã¼ã†']},
  {cat:'ğŸ æœç‰©', foods:['ã‚Šã‚“ã”','ãƒãƒŠãƒŠ','ã„ã¡ã”','ã¿ã‹ã‚“','æ¡ƒ','æ¢¨','ã¶ã©ã†','ã™ã„ã‹','ã‚­ã‚¦ã‚¤','ãƒ¡ãƒ­ãƒ³']},
  {cat:'ğŸ«™ ãã®ä»–', foods:['ã ã—ï¼ˆæ˜†å¸ƒï¼‰','ã ã—ï¼ˆã‹ã¤ãŠï¼‰','æµ·è‹”','ã‚ã‹ã‚','ã—ã„ãŸã‘','ã—ã‚ã˜','ãˆã®ã','è±†ä¹³','ã‚ªãƒ¼ãƒˆãƒŸãƒ¼ãƒ«']}
];

var TICON = {æœã”ã¯ã‚“:'ğŸŒ…', ã²ã‚‹ã”ã¯ã‚“:'â˜€ï¸', æ™©ã”ã¯ã‚“:'ğŸŒ™', ãŠã‚„ã¤:'ğŸª'};
var RLBL  = {all:'å®Œé£Ÿ', half:'å°‘ã—æ®‹ã—ãŸ', no:'é£Ÿã¹ãªã‹ã£ãŸ'};
var RCLS  = {all:'r-all', half:'r-half', no:'r-no'};
var RTXT  = {all:'å®Œé£Ÿ ğŸ˜Š', half:'å°‘ã—æ®‹ã—ãŸ ğŸ˜', no:'é£Ÿã¹ãªã‹ã£ãŸ ğŸ˜£'};

// =============================================
// STORAGE
// =============================================
var DB = {
  get: function(k) {
    try { return JSON.parse(localStorage.getItem('bm_' + k)); } catch(e) { return null; }
  },
  set: function(k, v) {
    try { localStorage.setItem('bm_' + k, JSON.stringify(v)); } catch(e) {}
  },
  del: function(k) {
    localStorage.removeItem('bm_' + k);
  }
};

// =============================================
// STATE
// =============================================
var baby     = DB.get('baby')    || null;
var allergens= DB.get('alls')    || [];
var records  = DB.get('recs')    || [];
var stocks   = DB.get('stocks')  || [];
var toggles  = DB.get('toggles')|| {firstFood:true, expiry:true};

function saveAll() {
  DB.set('baby',    baby);
  DB.set('alls',    allergens);
  DB.set('recs',    records);
  DB.set('stocks',  stocks);
  DB.set('toggles', toggles);
}

// =============================================
// UTILS
// =============================================
function calcStage(birth) {
  if (!birth) return {stage:'â€”', months:0};
  var now = new Date();
  var b   = new Date(birth + '-01');
  var m   = (now.getFullYear() - b.getFullYear()) * 12 + (now.getMonth() - b.getMonth());
  var s   = m < 5  ? 'ã¾ã é›¢ä¹³é£Ÿå‰' :
            m <= 6  ? 'ã”ã£ãã‚“æœŸ'   :
            m <= 8  ? 'ã‚‚ãã‚‚ãæœŸ'   :
            m <= 11 ? 'ã‹ã¿ã‹ã¿æœŸ'   :
            m <= 18 ? 'ã±ãã±ãæœŸ'   : 'å¹¼å…é£ŸæœŸ';
  return {stage:s, months:m};
}

function todayStr() {
  return new Date().toISOString().slice(0, 10);
}

function parseJSON(raw) {
  var s = raw.replace(/```json/g, '').replace(/```/g, '').trim();
  return JSON.parse(s);
}

function el(id) { return document.getElementById(id); }

// =============================================
// API
// =============================================
function apiChat(messages, cb) {
  fetch('/api/chat', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({messages: messages})
  })
  .then(function(res) { return res.json(); })
  .then(function(data) {
    if (data.error) { cb(new Error(data.error), null); return; }
    cb(null, data.text);
  })
  .catch(function(e) { cb(e, null); });
}

function apiVision(base64, mediaType, cb) {
  fetch('/api/vision', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({base64: base64, mediaType: mediaType})
  })
  .then(function(res) { return res.json(); })
  .then(function(data) {
    if (data.error) { cb(new Error(data.error), null); return; }
    cb(null, data.text);
  })
  .catch(function(e) { cb(e, null); });
}

// =============================================
// INIT
// =============================================
window.onload = function() {
  setTimeout(function() {
    el('splash').classList.add('hide');
    if (!baby) {
      el('onboarding').classList.remove('hide');
    } else {
      showApp();
    }
  }, 1400);
};

function showApp() {
  el('onboarding').classList.add('hide');
  el('header').style.display = 'flex';
  el('nav').style.display    = 'flex';
  var now = new Date();
  el('today-str').textContent =
    now.getFullYear() + 'å¹´' + (now.getMonth()+1) + 'æœˆ' + now.getDate() + 'æ—¥ï¼ˆ' +
    'æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ'[now.getDay()] + 'ï¼‰';
  renderAll();
}

function renderAll() {
  renderHeader();
  renderSlots();
  renderRecords();
  renderStocks();
  renderSettings();
}

// =============================================
// HEADER
// =============================================
function renderHeader() {
  var st = calcStage(baby ? baby.birth : null);
  el('hd-name').textContent  = 'ğŸ‘¶ ' + (baby && baby.name ? baby.name : 'â€”');
  el('hd-stage').textContent = st.stage + 'ï¼ˆ' + st.months + 'ãƒ¶æœˆï¼‰';
}

// =============================================
// ONBOARDING
// =============================================
var obAlls    = [];
var obEaten   = [];

function obStep1Next() {
  var name  = el('ob-name').value.trim();
  var birth = el('ob-birth').value;
  if (!name)  { alert('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if (!birth) { alert('ç”Ÿå¹´æœˆæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  el('ob1').classList.remove('active');
  el('ob2').classList.add('active');
}

function obAddAll() {
  var v = el('ob-all-input').value.trim();
  if (!v) return;
  obAlls.push(v);
  el('ob-all-input').value = '';
  renderObAlls();
}

function renderObAlls() {
  var html = '';
  if (obAlls.length === 0) {
    html = '<span style="font-size:13px;color:var(--sb)">ã¾ã ç™»éŒ²ãªã—</span>';
  } else {
    for (var i = 0; i < obAlls.length; i++) {
      html += '<div class="atag">' + obAlls[i] +
        '<button onclick="obAlls.splice(' + i + ',1);renderObAlls()">Ã—</button></div>';
    }
  }
  el('ob-alls').innerHTML = html;
}

function obStep2Next() {
  el('ob2').classList.remove('active');
  el('ob3').classList.add('active');
  renderObFoodList();
}

function renderObFoodList() {
  var html = '';
  for (var ci = 0; ci < FOOD_CATS.length; ci++) {
    var cat = FOOD_CATS[ci];
    html += '<div class="fcat">' + cat.cat + '</div><div class="fchips">';
    for (var fi = 0; fi < cat.foods.length; fi++) {
      var f   = cat.foods[fi];
      var sel = obEaten.indexOf(f) >= 0;
      var sid = 'fc' + ci + '_' + fi;
      html += '<div class="fchip' + (sel ? ' sel' : '') + '" id="' + sid +
        '" onclick="toggleObFood(' + ci + ',' + fi + ')">' + f + '</div>';
    }
    html += '</div>';
  }
  el('ob-food-list').innerHTML = html;
}

function toggleObFood(ci, fi) {
  var f   = FOOD_CATS[ci].foods[fi];
  var idx = obEaten.indexOf(f);
  if (idx >= 0) {
    obEaten.splice(idx, 1);
  } else {
    obEaten.push(f);
  }
  var sid = 'fc' + ci + '_' + fi;
  var chip = el(sid);
  if (chip) {
    if (obEaten.indexOf(f) >= 0) {
      chip.classList.add('sel');
    } else {
      chip.classList.remove('sel');
    }
  }
}

function obFinish() {
  baby = {
    name:  el('ob-name').value.trim(),
    birth: el('ob-birth').value
  };
  allergens = obAlls.slice();
  var eaten = DB.get('eaten') || [];
  for (var i = 0; i < obEaten.length; i++) {
    if (eaten.indexOf(obEaten[i]) < 0) eaten.push(obEaten[i]);
  }
  DB.set('eaten', eaten);
  saveAll();
  showApp();
}

// =============================================
// PAGE NAV
// =============================================
function goPage(id) {
  var pages = document.querySelectorAll('.page');
  for (var i = 0; i < pages.length; i++) pages[i].classList.remove('active');
  var btns = document.querySelectorAll('.nav-btn');
  for (var j = 0; j < btns.length; j++) btns[j].classList.remove('active');
  el('pg-' + id).classList.add('active');
  el('nb-' + id).classList.add('active');
}

// =============================================
// HOME: SLOTS
// =============================================
function renderSlots() {
  var today = todayStr();
  var html  = '';
  var slots = [
    {label:'æœã”ã¯ã‚“', icon:'ğŸŒ…'},
    {label:'ã²ã‚‹ã”ã¯ã‚“', icon:'â˜€ï¸'},
    {label:'æ™©ã”ã¯ã‚“', icon:'ğŸŒ™'}
  ];
  for (var i = 0; i < slots.length; i++) {
    var sl  = slots[i];
    var rec = null;
    for (var j = 0; j < records.length; j++) {
      if (records[j].date === today && records[j].time === sl.label) { rec = records[j]; break; }
    }
    if (rec) {
      html += '<div class="slot done">';
      html += '<div style="font-size:26px">' + sl.icon + '</div>';
      html += '<div style="flex:1"><div style="font-size:11px;color:var(--sb);font-weight:700">' + sl.label + '</div>';
      html += '<div style="font-size:14px;font-weight:700">' + rec.name + '</div>';
      html += '<div style="font-size:12px;color:var(--sb);margin-top:2px">' + (RTXT[rec.reaction] || '') + '</div></div>';
      html += '<div>âœ…</div></div>';
    } else {
      html += '<div class="slot" onclick="openRecModal(\'' + sl.label + '\')">';
      html += '<div style="font-size:26px">' + sl.icon + '</div>';
      html += '<div style="flex:1"><div style="font-size:11px;color:var(--sb);font-weight:700">' + sl.label + '</div>';
      html += '<div style="font-size:14px;font-weight:400;color:var(--sb)">ã‚¿ãƒƒãƒ—ã—ã¦è¨˜éŒ²ã™ã‚‹</div></div>';
      html += '<div style="color:var(--sb)">ï¼‹</div></div>';
    }
  }
  el('slots').innerHTML = html;
}

// =============================================
// AI PROPOSAL
// =============================================
function runPropose() {
  var btn = el('propose-btn');
  btn.disabled = true;
  btn.textContent = 'è€ƒãˆä¸­...';
  el('propose-result').innerHTML =
    '<div style="display:flex;align-items:center;gap:10px;padding-top:14px">' +
    '<div class="dot3"><span></span><span></span><span></span></div>' +
    '<span style="font-size:13px;opacity:.7">ç›´è¿‘3é£Ÿã‚’åˆ†æã—ã¦ã„ã¾ã™...</span></div>';

  var st       = calcStage(baby ? baby.birth : null);
  var recent   = records.slice(-3);
  var rTxt     = recent.length
    ? recent.map(function(r) {
        return 'ãƒ»' + r.time + 'ï¼š' + r.name + 'ï¼ˆ' + (RLBL[r.reaction] || '') + 'ï¼‰';
      }).join('\n')
    : 'ãƒ»è¨˜éŒ²ãªã—';
  var sTxt     = stocks.length ? stocks.map(function(s) { return s.name; }).join('ã€') : 'ãªã—';
  var eaten    = DB.get('eaten') || [];
  var eTxt     = eaten.length ? eaten.join('ã€') : 'ãªã—ï¼ˆã™ã¹ã¦åˆé£Ÿææ‰±ã„ï¼‰';

  var prompt =
    'ã‚ãªãŸã¯é›¢ä¹³é£Ÿã®ç®¡ç†æ „é¤Šå£«ã§ã™ã€‚\n' +
    'æœˆé½¢:' + st.months + 'ãƒ¶æœˆ(' + st.stage + ')\n' +
    'ç›´è¿‘3é£Ÿ:\n' + rTxt + '\n' +
    'å†·å‡ã‚¹ãƒˆãƒƒã‚¯:' + sTxt + '\n' +
    'ã“ã‚Œã¾ã§ã«é£Ÿã¹ãŸã“ã¨ãŒã‚ã‚‹é£Ÿæ:' + eTxt + '\n\n' +
    'ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã§æ¬¡ã®é£Ÿäº‹ã®çŒ®ç«‹ã‚’ææ¡ˆã—ã¦ãã ã•ã„ï¼š\n' +
    '- å†·å‡ã‚¹ãƒˆãƒƒã‚¯ã‚’å„ªå…ˆã—ã¦ä½¿ã†\n' +
    '- é£Ÿã¹ãŸã“ã¨ãŒã‚ã‚‹é£Ÿæã‚’å„ªå…ˆã—ã€æ…£ã‚ŒãŸé£Ÿæã§å®‰å¿ƒã§ãã‚‹çŒ®ç«‹ã«ã™ã‚‹\n' +
    '- æ–°ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯1å“ã®ã¿\n' +
    '- é£Ÿã¹ãŸã“ã¨ãŒãªã„é£Ÿæã‚’ä½¿ã†å ´åˆã¯warningã«é£Ÿæåã‚’æ˜è¨˜ã™ã‚‹\n' +
    '- å„ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«å¿…è¦ãªé£Ÿæã¨æœˆé½¢ã«åˆã£ãŸ1å›é‡ã®ç›®å®‰ã‚’è¨˜è¼‰\n' +
    '- ç›´è¿‘3é£Ÿã§ä¸è¶³ã—ã¦ã„ã‚‹æ „é¤Šç´ ã‚’è£œã†é£Ÿæã‚‚ææ¡ˆ\n\n' +
    'JSONã®ã¿è¿”ã—ã¦ãã ã•ã„ï¼ˆãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ä¸è¦ï¼‰ï¼š\n' +
    '{"analysis":"æ „é¤Šåˆ†æ25å­—ä»¥å†…","menu":[{"icon":"çµµæ–‡å­—","name":"æ–™ç†å","type":"stock ã¾ãŸã¯ new",' +
    '"ingredients":[{"name":"é£Ÿæå","amount":"1å›é‡ã®ç›®å®‰","isNew":true ã¾ãŸã¯ false}]}],' +
    '"warning":"åˆé£ŸæãŒã‚ã‚‹å ´åˆã¯é£Ÿæåã‚’æ˜è¨˜ã€ãªã‘ã‚Œã°null",' +
    '"nutritionSuggestion":{"missing":"ä¸è¶³æ „é¤Šç´ ","foods":[{"icon":"çµµæ–‡å­—","name":"é£Ÿæå","amount":"1å›é‡ç›®å®‰","reason":"ç†ç”±10å­—ä»¥å†…"}]}}';

  apiChat([{role:'user', content:prompt}], function(err, text) {
    btn.disabled = false;
    btn.innerHTML = 'âœ¨ çŒ®ç«‹ã‚’ææ¡ˆã—ã¦ã‚‚ã‚‰ã†';
    if (err) {
      el('propose-result').innerHTML =
        '<div class="ebox"><div class="ebox-t">âŒ ã‚¨ãƒ©ãƒ¼è©³ç´°</div>' +
        '<div class="ebox-p">' + err.message + '</div>' +
        '<button class="ai-btn" style="margin-top:10px;padding:8px 0;font-size:12px" onclick="runPropose()">ğŸ”„ å†è©¦è¡Œ</button></div>';
      return;
    }
    try {
      renderProposal(parseJSON(text));
    } catch(e) {
      el('propose-result').innerHTML =
        '<div class="ebox"><div class="ebox-t">âŒ è§£æã‚¨ãƒ©ãƒ¼</div>' +
        '<div class="ebox-p">' + e.message + '\n\n' + text + '</div></div>';
    }
  });
}

function renderProposal(d) {
  var menu = d.menu || [];
  var mHtml = '';
  for (var i = 0; i < menu.length; i++) {
    var m    = menu[i];
    var ings = m.ingredients || [];
    var ingStr = '';
    for (var j = 0; j < ings.length; j++) {
      ingStr += ings[j].name + ' ' + ings[j].amount;
      if (ings[j].isNew) ingStr += ' <span style="color:var(--ye);font-size:10px">â˜…åˆ</span>';
      if (j < ings.length - 1) ingStr += 'ãƒ»';
    }
    mHtml +=
      '<div class="mrow">' +
      '<div style="font-size:20px;flex-shrink:0;margin-top:1px">' + m.icon + '</div>' +
      '<div style="flex:1"><div class="mname">' + m.name + '</div>' +
      (ingStr ? '<div class="ming">é£Ÿæï¼š' + ingStr + '</div>' : '') + '</div>' +
      '<span class="tag ' + (m.type === 'new' ? 'tag-new' : 'tag-stk') + '">' +
      (m.type === 'new' ? 'æ–°ãƒ¡ãƒ‹ãƒ¥ãƒ¼' : 'å†·å‡ã‚¹ãƒˆãƒƒã‚¯') + '</span>' +
      '</div>';
  }

  var ns    = d.nutritionSuggestion;
  var nsHtml = '';
  if (ns && ns.foods && ns.foods.length) {
    var items = '';
    for (var k = 0; k < ns.foods.length; k++) {
      var f = ns.foods[k];
      items +=
        '<div class="sitem">' +
        '<span style="font-size:18px;flex-shrink:0">' + f.icon + '</span>' +
        '<div><div style="font-size:13px;font-weight:700">' + f.name + '</div>' +
        '<div style="font-size:11px;opacity:.65;margin-top:2px">1å›é‡ï¼š' + f.amount + 'ã€€' + f.reason + '</div></div>' +
        '</div>';
    }
    nsHtml = '<div class="nsugg"><div class="nsugg-t">ğŸ”‹ ä¸è¶³æ „é¤Šç´ ï¼ˆ' + ns.missing + 'ï¼‰ã‚’è£œã†é£Ÿæ</div>' + items + '</div>';
  }

  var warn = (d.warning && d.warning !== 'null')
    ? '<div style="font-size:12px;opacity:.8;margin-bottom:8px">âš  ' + d.warning + '</div>' : '';

  el('propose-result').innerHTML =
    '<div style="margin-top:14px">' +
    '<div style="font-size:13px;opacity:.75;margin-bottom:10px">ğŸ“Š ' + d.analysis + '</div>' +
    '<div class="pbox">' + mHtml + '</div>' +
    warn + nsHtml +
    '<div class="pbtns">' +
    '<button class="pbtn pbtn-a" id="adopt-btn" onclick="adoptProposal()">âœ… ã“ã®çŒ®ç«‹ã‚’ä½¿ã†</button>' +
    '<button class="pbtn pbtn-r" onclick="runPropose()">ğŸ”„ åˆ¥ã®ææ¡ˆ</button>' +
    '</div></div>';
}

function adoptProposal() {
  var btn = el('adopt-btn');
  if (btn) { btn.textContent = 'âœ… æ¡ç”¨æ¸ˆã¿'; btn.disabled = true; }
}

// =============================================
// RECORD MODAL
// =============================================
var recReaction = 'all';
var recPhoto    = null;

function openRecModal(preset) {
  recReaction = 'all';
  recPhoto    = null;
  el('rec-name').value     = '';
  el('photo-input').value  = '';
  el('vision-result').innerHTML = '';
  el('photo-area').innerHTML =
    '<div style="font-size:32px;margin-bottom:6px">ğŸ“·</div>' +
    '<p style="font-size:13px;color:var(--sb)">ã‚¿ãƒƒãƒ—ã—ã¦å†™çœŸã‚’é¸ã¶<br>' +
    '<span style="font-size:11px;color:var(--g)">AIãŒé£Ÿæãƒ»æ „é¤Šã‚’è‡ªå‹•è§£æã—ã¾ã™</span></p>';
  var opts = ['all', 'half', 'no'];
  for (var i = 0; i < opts.length; i++) {
    var el2 = document.getElementById('r-' + opts[i]);
    if (el2) { el2.classList.toggle('sel', opts[i] === 'all'); }
  }
  if (preset) el('rec-time').value = preset;
  el('rec-modal').classList.remove('hide');
}

function closeRecModal() {
  el('rec-modal').classList.add('hide');
}

function selReact(v) {
  recReaction = v;
  var opts = ['all', 'half', 'no'];
  for (var i = 0; i < opts.length; i++) {
    var el2 = document.getElementById('r-' + opts[i]);
    if (el2) el2.classList.toggle('sel', opts[i] === v);
  }
}

function handlePhoto(e) {
  var file = e.target.files && e.target.files[0];
  if (!file) return;
  var reader = new FileReader();
  reader.onload = function(ev) {
    var url   = ev.target.result;
    var b64   = url.split(',')[1];
    var mtype = url.match(/data:([^;]+)/)[1];
    recPhoto  = url;
    el('photo-area').innerHTML =
      '<img src="' + url + '" style="width:90px;height:90px;object-fit:cover;border-radius:10px">';
    showVisionLoading('AIãŒå†™çœŸã‚’è§£æä¸­...');
    apiVision(b64, mtype, function(err, text) {
      if (err) { showVisionError(err.message); return; }
      try {
        var json = parseJSON(text);
        if (json.dishName && !el('rec-name').value) el('rec-name').value = json.dishName;
        renderNutrCard(json);
      } catch(e2) {
        showVisionError(e2.message);
      }
    });
  };
  reader.readAsDataURL(file);
}

function reanalyze() {
  var name = el('rec-name').value.trim();
  if (!name) { alert('æ–™ç†åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  showVisionLoading('ã€Œ' + name + 'ã€ã‚’å†è§£æä¸­...');
  if (recPhoto) {
    var b64   = recPhoto.split(',')[1];
    var mtype = recPhoto.match(/data:([^;]+)/)[1];
    apiVision(b64, mtype, function(err, text) {
      if (err) { showVisionError(err.message); return; }
      try { renderNutrCard(parseJSON(text)); } catch(e) { showVisionError(e.message); }
    });
  } else {
    var prompt =
      'é›¢ä¹³é£Ÿã€Œ' + name + 'ã€ã®æ „é¤Šã‚’æ¨å®šã—ã¦ãã ã•ã„ã€‚\n' +
      'JSONã®ã¿è¿”ã—ã¦ãã ã•ã„ï¼ˆãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ä¸è¦ï¼‰ï¼š\n' +
      '{"dishName":"æ–™ç†å","nutrition":{"protein":0ã‹ã‚‰100ã®æ•´æ•°,"iron":0ã‹ã‚‰100ã®æ•´æ•°,"carbs":0ã‹ã‚‰100ã®æ•´æ•°,"calcium":0ã‹ã‚‰100ã®æ•´æ•°},' +
      '"advice":"æ¬¡ã®é£Ÿäº‹ã¸ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹25å­—ä»¥å†…","missingNutrients":["ä¸è¶³æ „é¤Šç´ 1","ä¸è¶³æ „é¤Šç´ 2"]}';
    apiChat([{role:'user', content:prompt}], function(err, text) {
      if (err) { showVisionError(err.message); return; }
      try { renderNutrCard(parseJSON(text)); } catch(e) { showVisionError(e.message); }
    });
  }
}

function showVisionLoading(msg) {
  el('vision-result').innerHTML =
    '<div style="background:var(--gp);border-radius:10px;padding:12px;display:flex;align-items:center;gap:9px;margin-top:8px">' +
    '<div class="dot3"><span></span><span></span><span></span></div>' +
    '<span style="font-size:13px;color:var(--g);font-weight:700">' + msg + '</span></div>';
}

function showVisionError(msg) {
  el('vision-result').innerHTML =
    '<div style="background:var(--op);border-radius:10px;padding:12px;margin-top:8px">' +
    '<div style="font-size:12px;font-weight:700;color:var(--or);margin-bottom:6px">âŒ è§£æã‚¨ãƒ©ãƒ¼</div>' +
    '<pre style="font-size:11px;color:var(--sb);white-space:pre-wrap;word-break:break-all;font-family:monospace">' + msg + '</pre>' +
    '<div style="font-size:11px;color:var(--sb);margin-top:6px">æ–™ç†åã‚’æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div></div>';
}

function renderNutrCard(n) {
  var items = [
    ['ã‚¿ãƒ³ãƒ‘ã‚¯è³ª', n.nutrition ? n.nutrition.protein  : 0],
    ['é‰„åˆ†',       n.nutrition ? n.nutrition.iron     : 0],
    ['ç‚­æ°´åŒ–ç‰©',   n.nutrition ? n.nutrition.carbs    : 0],
    ['ã‚«ãƒ«ã‚·ã‚¦ãƒ ', n.nutrition ? n.nutrition.calcium  : 0]
  ];
  function col(v) { return v >= 60 ? 'var(--g)' : v >= 40 ? '#d97706' : 'var(--or)'; }
  function lbl(v) { return v >= 60 ? 'è‰¯å¥½' : v >= 40 ? 'æ™®é€š' : 'ã‚„ã‚„ä¸è¶³'; }
  var bars = '';
  for (var i = 0; i < items.length; i++) {
    var l = items[i][0], v = items[i][1] || 0;
    bars +=
      '<div class="nrow">' +
      '<div class="nhd"><span>' + l + '</span><span style="color:var(--sb)">' + lbl(v) + '</span></div>' +
      '<div class="ntrack"><div class="nfill" style="width:' + v + '%;background:' + col(v) + '"></div></div>' +
      '</div>';
  }
  var missing = (n.missingNutrients || []).join('ãƒ»');
  el('vision-result').innerHTML =
    '<div class="ncrd">' +
    '<div style="font-size:12px;font-weight:700;color:var(--g);margin-bottom:10px">ğŸ” AIæ „é¤Šè§£æçµæœ</div>' +
    bars +
    (missing ? '<div style="font-size:12px;color:var(--or);margin-top:6px">âš  ä¸è¶³ãŒæ°—ã«ãªã‚‹æ „é¤Šç´ ï¼š' + missing + '</div>' : '') +
    '<div style="font-size:12px;color:var(--or);margin-top:8px">ğŸ’¡ ' + (n.advice || '') + '</div>' +
    '<div style="font-size:10px;color:var(--sb);margin-top:3px">â€»AIã«ã‚ˆã‚‹æ¨å®šå€¤ã§ã™ã€‚åŒ»ç™‚çš„åˆ¤æ–­ã«ã¯ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚</div>' +
    '</div>';
}

function saveRecord() {
  var name = el('rec-name').value.trim();
  if (!name) { alert('æ–™ç†åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  var time = el('rec-time').value;
  var date = todayStr();
  records.push({id:Date.now(), date:date, time:time, name:name, reaction:recReaction, photo:recPhoto});
  saveAll();
  closeRecModal();
  renderSlots();
  renderRecords();
  goPage('home');
}

// =============================================
// RECORDS PAGE
// =============================================
function renderRecords() {
  var today = todayStr();
  var yest  = new Date(); yest.setDate(yest.getDate() - 1);
  var yestS = yest.toISOString().slice(0, 10);

  if (!records.length) {
    el('rec-list').innerHTML = '<div class="empty"><div class="ei">ğŸ“–</div><p>ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
    return;
  }

  var groups = {};
  var rev    = records.slice().reverse();
  for (var i = 0; i < rev.length; i++) {
    var r = rev[i];
    if (!groups[r.date]) groups[r.date] = [];
    groups[r.date].push(r);
  }

  var html  = '';
  var dates = Object.keys(groups);
  for (var di = 0; di < dates.length; di++) {
    var date  = dates[di];
    var label = date === today ? 'ä»Šæ—¥' : date === yestS ? 'æ˜¨æ—¥' : date;
    var recs  = groups[date];
    html += '<div style="margin-bottom:18px"><div class="dayhd">' + label + '</div>';
    for (var ri = 0; ri < recs.length; ri++) {
      var rec   = recs[ri];
      var thumb = rec.photo
        ? '<img src="' + rec.photo + '" alt="">'
        : (TICON[rec.time] || 'ğŸ½');
      html +=
        '<div class="ritem">' +
        '<div class="rthumb">' + thumb + '</div>' +
        '<div style="flex:1;min-width:0">' +
        '<div class="rname">' + rec.name + '</div>' +
        '<div class="rmeta">' + (TICON[rec.time] || 'ğŸ½') + ' ' + rec.time + '</div></div>' +
        '<div class="rbadge ' + (RCLS[rec.reaction] || '') + '">' + (RLBL[rec.reaction] || '') + '</div>' +
        '</div>';
    }
    html += '</div>';
  }
  el('rec-list').innerHTML = html;
}

// =============================================
// STOCKS
// =============================================
function openStockModal() {
  el('sm-emoji').value = '';
  el('sm-name').value  = '';
  el('sm-amt').value   = '';
  el('sm-date').value  = todayStr();
  el('stock-modal').classList.remove('hide');
}
function closeStockModal() {
  el('stock-modal').classList.add('hide');
}
function saveStock() {
  var name = el('sm-name').value.trim();
  if (!name) { alert('æ–™ç†åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  stocks.push({
    id:     Date.now(),
    emoji:  el('sm-emoji').value.trim() || 'ğŸ±',
    name:   name,
    amount: el('sm-amt').value.trim()   || 'â€”',
    date:   el('sm-date').value
  });
  saveAll();
  closeStockModal();
  renderStocks();
}
function delStock(i) {
  if (!confirm('ã“ã®ã‚¹ãƒˆãƒƒã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  stocks.splice(i, 1);
  saveAll();
  renderStocks();
}
function renderStocks() {
  var now   = new Date();
  el('stock-count').textContent = stocks.length + 'å“';
  var warns = 0;
  for (var i = 0; i < stocks.length; i++) {
    var exp = new Date(stocks[i].date); exp.setDate(exp.getDate() + 14);
    if (Math.ceil((exp - now) / 86400000) <= 3) warns++;
  }
  var wm = el('stock-warn-msg');
  if (warns > 0 && toggles.expiry) {
    wm.style.display = 'block';
    wm.textContent   = 'âš  ' + warns + 'å“ãŒä»Šé€±ä¸­ã«æœŸé™åˆ‡ã‚Œã§ã™';
  } else {
    wm.style.display = 'none';
  }
  if (!stocks.length) {
    el('stock-grid').innerHTML         = '';
    el('stock-empty').style.display    = 'block';
    return;
  }
  el('stock-empty').style.display = 'none';
  var html = '';
  for (var si = 0; si < stocks.length; si++) {
    var s    = stocks[si];
    var exp2 = new Date(s.date); exp2.setDate(exp2.getDate() + 14);
    var days = Math.ceil((exp2 - now) / 86400000);
    var warn = toggles.expiry && days <= 3;
    html +=
      '<div class="scard' + (warn ? ' warn' : '') + '">' +
      '<button class="sdel" onclick="delStock(' + si + ')">âœ•</button>' +
      '<div style="font-size:26px;margin-bottom:7px">' + s.emoji + '</div>' +
      '<div style="font-size:13px;font-weight:700">' + s.name + '</div>' +
      '<div style="font-size:12px;color:var(--sb)">' + s.amount + '</div>' +
      '<div style="font-size:11px;font-weight:600;margin-top:5px;color:' + (warn ? 'var(--or)' : 'var(--g)') + '">' +
      (warn ? 'âš  ' + days + 'æ—¥å¾Œã«æœŸé™' : 'âœ… ã‚ã¨' + days + 'æ—¥') + '</div>' +
      '</div>';
  }
  el('stock-grid').innerHTML = html;
}

// =============================================
// SETTINGS
// =============================================
function renderSettings() {
  var st       = calcStage(baby ? baby.birth : null);
  var birthStr = 'â€”';
  if (baby && baby.birth) {
    var d = new Date(baby.birth + '-01');
    birthStr = d.getFullYear() + 'å¹´' + (d.getMonth() + 1) + 'æœˆ';
  }
  el('s-name').textContent   = baby && baby.name ? baby.name : 'â€”';
  el('s-birth').textContent  = birthStr;
  el('s-stage').textContent  = st.stage;
  el('s-months').textContent = st.months + 'ãƒ¶æœˆ';
  el('tog-first').classList.toggle('on', toggles.firstFood);
  el('tog-exp').classList.toggle('on',   toggles.expiry);
  renderSAlls();
  renderSEaten();
}

function renderSAlls() {
  var html = '';
  if (!allergens.length) {
    html = '<span style="font-size:13px;color:var(--sb)">ç™»éŒ²ãªã—</span>';
  } else {
    for (var i = 0; i < allergens.length; i++) {
      html += '<div class="atag">' + allergens[i] +
        '<button onclick="delAll(' + i + ')">Ã—</button></div>';
    }
  }
  el('s-alls').innerHTML = html;
}
function sAddAll() {
  var v = el('s-all-input').value.trim();
  if (!v) return;
  allergens.push(v);
  el('s-all-input').value = '';
  saveAll(); renderSAlls();
}
function delAll(i) {
  allergens.splice(i, 1); saveAll(); renderSAlls();
}

function renderSEaten() {
  var eaten = DB.get('eaten') || [];
  var html  = '';
  if (!eaten.length) {
    html = '<span style="font-size:13px;color:var(--sb)">ã¾ã ç™»éŒ²ãªã—</span>';
  } else {
    for (var i = 0; i < eaten.length; i++) {
      html += '<div class="atag">' + eaten[i] +
        '<button onclick="delEaten(' + i + ')">Ã—</button></div>';
    }
  }
  el('s-eaten').innerHTML = html;
}
function sAddEaten() {
  var v = el('s-eaten-input').value.trim();
  if (!v) return;
  var eaten = DB.get('eaten') || [];
  if (eaten.indexOf(v) < 0) { eaten.push(v); DB.set('eaten', eaten); }
  el('s-eaten-input').value = '';
  renderSEaten();
}
function delEaten(i) {
  var eaten = DB.get('eaten') || [];
  eaten.splice(i, 1); DB.set('eaten', eaten); renderSEaten();
}

function editName() {
  var v = prompt('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„', baby && baby.name ? baby.name : '');
  if (v === null) return;
  if (!v.trim()) { alert('å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  baby.name = v.trim(); saveAll(); renderHeader(); renderSettings();
}
function editBirth() {
  var v = prompt('ç”Ÿå¹´æœˆæ—¥ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ï¼ˆä¾‹: 2024-07ï¼‰', baby && baby.birth ? baby.birth : '');
  if (v === null) return;
  if (!/^\d{4}-\d{2}$/.test(v)) { alert('å½¢å¼: 2024-07'); return; }
  baby.birth = v; saveAll(); renderHeader(); renderSettings();
}
function togFirst() {
  toggles.firstFood = !toggles.firstFood; saveAll();
  el('tog-first').classList.toggle('on', toggles.firstFood);
}
function togExp() {
  toggles.expiry = !toggles.expiry; saveAll();
  el('tog-exp').classList.toggle('on', toggles.expiry);
  renderStocks();
}
function resetData() {
  if (!confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚\nã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
  var keys = ['baby','alls','recs','stocks','toggles','eaten'];
  for (var i = 0; i < keys.length; i++) DB.del(keys[i]);
  location.reload();
}

// =============================================
// MODAL BG CLICK TO CLOSE
// =============================================
el('rec-modal').addEventListener('click', function(e) {
  if (e.target === e.currentTarget) closeRecModal();
});
el('stock-modal').addEventListener('click', function(e) {
  if (e.target === e.currentTarget) closeStockModal();
});
</script>
</body>
</html>
